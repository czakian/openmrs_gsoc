<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">
	
	<!-- 
	
		See http://www.liquibase.org/manual/home#available_database_refactorings 
		for a list of supported elements and attributes 
		
	-->
	
	
	<!--
		Check that the sqldiff has been run up to at least the 1.4.0.20 version.
		If it hasn't, this script won't run.  
	  -->
	<preConditions>
		<or>
			<sqlCheck expectedResult="database_version greater than 1.4.0.20">
				<![CDATA[
				SELECT case when REPLACE(property_value, '.', '0') >= REPLACE('1.4.0.20', '.', '0') then 'database_version greater than 1.4.0.20' else 'The update-to-latest.sql file needs to be run on this db.' end FROM global_property WHERE property = 'database_version';
				]]>
			</sqlCheck>
			<sqlCheck expectedResult="no database_version property after v1.4.0.20">
				<![CDATA[
				SELECT case when count(*) = 1 then 'a non-empty database_version global property' else 'no database_version property after v1.4.0.20' end FROM global_property WHERE property = 'database_version';
				]]>
			</sqlCheck>
		</or>
	</preConditions>
	
	
	
	<changeSet id="1" author="upul">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				<![CDATA[
				SELECT REPLACE(property_value, '.', '0') < REPLACE('1.5.0.01', '.', '0') FROM global_property WHERE property = 'database_version';
				]]>
			</sqlCheck>
		</preConditions>
		<comment>
			Add the column to person_attribute type to connect
			each type to a privilege
			(preCondition database_version check in place because this change was in the old format in trunk for a while)
		</comment>
		<addColumn tableName="person_attribute_type">
			<column name="edit_privilege" type="varchar(255)" />
		</addColumn>
	</changeSet>
	
	<changeSet id="2" author="upul">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				<![CDATA[
				SELECT REPLACE(property_value, '.', '0') < REPLACE('1.5.0.01', '.', '0') FROM global_property WHERE property = 'database_version';
				]]>
			</sqlCheck>
		</preConditions>
		<comment>
			Create the foreign key from the privilege required for to edit
			a person attribute type and the privilege.privilege column
			(preCondition database_version check in place because this change was in the old format in trunk for a while)
		</comment>
		<addForeignKeyConstraint constraintName="privilege_which_can_edit"
			baseTableName="person_attribute_type" baseColumnNames="edit_privilege"
			referencedTableName="privilege" referencedColumnNames="privilege"
		    />
    </changeSet>
    
	<changeSet id="200811261102" author="bwolfe">
		<comment>
			Fix field property for new Tribe person attribute
		</comment>
		<update tableName="field">
			<column name="default_value" value="$!{patient.attributeMap.Tribe.hydratedObject.tribeId}^$!{patient.attributeMap.Tribe.hydratedObject.name}"/>
			<where>default_value='$!{patient.getTribe().getTribeId()}^$!{patient.getTribe().getName()}'</where>
		</update>
    </changeSet>
    
	<changeSet id="200805281223" author="bmckown">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				<![CDATA[
				SELECT REPLACE(property_value, '.', '0') < REPLACE('1.5.0.03', '.', '0') FROM global_property WHERE property = 'database_version';
				]]>
			</sqlCheck>
		</preConditions>
		<comment>
			Create the concept_complex table
			(preCondition database_version check in place because this change was in the old format in trunk for a while)
		</comment>
		<createTable tableName="concept_complex">
			<column name="concept_id" type="int">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="handler" type="varchar(255)"/>
		</createTable>
		
		<addForeignKeyConstraint constraintName="concept_attributes"
			baseTableName="concept_complex" baseColumnNames="concept_id"
			referencedTableName="concept" referencedColumnNames="concept_id"
			/>		
    </changeSet>
    
	<changeSet id="200805281224" author="bmckown">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				<![CDATA[
				SELECT REPLACE(property_value, '.', '0') < REPLACE('1.5.0.03', '.', '0') FROM global_property WHERE property = 'database_version';
				]]>
			</sqlCheck>
		</preConditions>
		<comment>
			Adding the value_complex column to obs.  This may take a long time if you have a large number of observations.
			
			(preCondition database_version check in place because this change was in the old format in trunk for a while)
		</comment>
		<addColumn tableName="obs">
			<column name="value_complex" type="varchar(255)" />
		</addColumn>
	</changeSet>
	
	<changeSet id="200805281225" author="bmckown">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
				<![CDATA[
				SELECT count(*) FROM concept_datatype where name='Complex';
				]]>
			</sqlCheck>
		</preConditions>
		<comment>
			Adding a 'complex' Concept Datatype
		</comment>
		<insert tableName="concept_datatype">
			<column name="name" value="Complex"/>
			<column name="hl7_abbreviation" value="ED"/>
			<column name="description" value="Complex value.  Analogous to HL7 Embedded Datatype"/>
			<column name="creator" valueNumeric="1"/>
			<column name="date_created" valueDate="2008-05-28T12:25:34" />
		</insert>
	</changeSet>
	
	<changeSet id="200805281226" author="bmckown">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				<![CDATA[
				SELECT REPLACE(property_value, '.', '0') < REPLACE('1.5.0.03', '.', '0') FROM global_property WHERE property = 'database_version';
				]]>
			</sqlCheck>
		</preConditions>
		<comment>
			Dropping the mimetype and complex_obs tables as they aren't needed in the new complex obs setup
			
			(preCondition database_version check in place because this change was in the old format in trunk for a while)
		</comment>
		
		<dropTable tableName="complex_obs"/>
		<dropTable tableName="mime_type"/>
		
	</changeSet>
	
	<changeSet id="200809191226" author="smbugua">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				<![CDATA[
				SELECT REPLACE(property_value, '.', '0') < REPLACE('1.5.0.04', '.', '0') FROM global_property WHERE property = 'database_version';
				]]>
			</sqlCheck>
		</preConditions>
		<comment>
			Adding the hl7 archive message_state column so that archives can be tracked
			
			(preCondition database_version check in place because this change was in the old format in trunk for a while)
		</comment>
		<addColumn tableName="hl7_in_archive">
			<column name="message_state" type="int(1)" defaultValueNumeric="0" remarks="2=processed, 4=deleted" />
		</addColumn>
	</changeSet>

	<changeSet id="200809191927" author="smbugua">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				<![CDATA[
				SELECT REPLACE(property_value, '.', '0') < REPLACE('1.5.0.04', '.', '0') FROM global_property WHERE property = 'database_version';
				]]>
			</sqlCheck>
		</preConditions>
		<comment>
			Adding the hl7 archive message_state column so that archives can be tracked
			
			(preCondition database_version check in place because this change was in the old format in trunk for a while)
		</comment>
		<renameColumn tableName="hl7_in_queue" oldColumnName="state" newColumnName="message_state" columnDataType="int(1)"/>
		
		<modifyColumn tableName="hl7_in_queue">
			<column name="message_state" type="int(1)" defaultValueNumeric="0" remarks="0=pending, 1=processing, 2=processed, 3=error">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
	</changeSet>
	
	<changeSet id="200901101524" author="Knoll_Frank">
		<comment>
			Changing datatype of drug.retire_reason from DATETIME to varchar(255)
		</comment>
		<modifyColumn tableName="drug">
		    <column name="retire_reason" type="varchar(255)"/>
		</modifyColumn>
	</changeSet>
	
	<changeSet id="200901130950" author="bwolfe">
		<comment>
			Remove Manage Tribes and View Tribes privileges from all roles
		</comment>
		
		<delete tableName="role_privilege">
			<where>privilege='Manage Tribes' and not exists (select * from privilege where privilege = 'Manage Tribes')</where>
		</delete>
		
		<delete tableName="role_privilege">
			<where>privilege='View Tribes' and not exists (select * from privilege where privilege = 'View Tribes')</where>
		</delete>
	</changeSet>
	
	<changeSet id="200901130951" author="bwolfe">
		<comment>
			Remove Manage Mime Types, View Mime Types, and Purge Mime Types privilege
		</comment>
		
		<delete tableName="role_privilege">
			<where>privilege in ('Manage Mime Types', 'View Mime Types', 'Purge Mime Types')</where>
		</delete>
		
		<delete tableName="privilege">
			<where>privilege in ('Manage Mime Types', 'View Mime Types', 'Purge Mime Types')</where>
		</delete>
	</changeSet>
	
	<changeSet id="200901161126" author="bwolfe">
		<comment>
			Removed the database_version global property
		</comment>
		
		<delete tableName="global_property">
			<where>property = 'database_version'</where>
		</delete>
		
	</changeSet>
	
	<changeSet id="20090121-0949" author="bwolfe">
		<comment>
			Switched the default xslt to use PV1-19 instead of PV1-1
		</comment>
		
		<!-- using the <sql> tag instead of the <update> tag here so that xml syntax highlighting doesn't bog down editors -->
		<sql splitStatements="false">
			<![CDATA[
				UPDATE form
				SET xslt = '<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n\r\n<!--\r\nOpenMRS FormEntry Form HL7 Translation\r\n\r\nThis XSLT is used to translate OpenMRS forms from XML into HL7 2.5 format\r\n\r\n@author Burke Mamlin, MD\r\n@author Ben Wolfe\r\n@version 1.9.7\r\n\r\n1.9.7 - moved encounter/encounter.encounter_id to use PV1-19 instead\r\n1.9.6 - added encounter/encounter.encounter_id to PV1-1\r\n1.9.5 - allow for organizing sections under \"obs\" section\r\n1.9.4 - add support for message uid (as HL7 control id) and transform of patient.health_center to Discharge to Location (PV1-37)\r\n1.9.3 - fixed rounding error on timestamp (tenths of seconds getting rounded up, causing \"60\" seconds in some cases) \r\n1.9.2 - first generally useful version\r\n-->\r\n\r\n<xsl:stylesheet version=\"2.0\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:fn=\"http://www.w3.org/2005/xpath-functions\" xmlns:xdt=\"http://www.w3.org/2005/xpath-datatypes\">\r\n	<xsl:output method=\"text\" version=\"1.0\" encoding=\"UTF-8\" indent=\"no\"/>\r\n\r\n<xsl:variable name=\"SENDING-APPLICATION\">FORMENTRY</xsl:variable>\r\n<xsl:variable name=\"SENDING-FACILITY\">AMRS.ELD</xsl:variable>\r\n<xsl:variable name=\"RECEIVING-APPLICATION\">HL7LISTENER</xsl:variable>\r\n<xsl:variable name=\"RECEIVING-FACILITY\">AMRS.ELD</xsl:variable>\r\n<xsl:variable name=\"PATIENT-AUTHORITY\"></xsl:variable> <!-- leave blank for internal id, max 20 characters -->\r\n                                                       <!-- for now, must match patient_identifier_type.name -->\r\n<xsl:variable name=\"FORM-AUTHORITY\">AMRS.ELD.FORMID</xsl:variable> <!-- max 20 characters -->\r\n\r\n<xsl:template match=\"/\">\r\n	<xsl:apply-templates />\r\n</xsl:template>\r\n\r\n<!-- Form template -->\r\n<xsl:template match=\"form\">\r\n	<!-- MSH Header -->\r\n	<xsl:text>MSH|^~\\&amp;</xsl:text>   <!-- Message header, field separator, and encoding characters -->\r\n	<xsl:text>|</xsl:text>              <!-- MSH-3 Sending application -->\r\n	<xsl:value-of select=\"$SENDING-APPLICATION\" />\r\n	<xsl:text>|</xsl:text>              <!-- MSH-4 Sending facility -->\r\n	<xsl:value-of select=\"$SENDING-FACILITY\" />\r\n	<xsl:text>|</xsl:text>              <!-- MSH-5 Receiving application -->\r\n	<xsl:value-of select=\"$RECEIVING-APPLICATION\" />\r\n	<xsl:text>|</xsl:text>              <!-- MSH-6 Receiving facility -->\r\n	<xsl:value-of select=\"$RECEIVING-FACILITY\" />\r\n	<xsl:text>|</xsl:text>              <!-- MSH-7 Date/time message sent -->\r\n	<xsl:call-template name=\"hl7Timestamp\">\r\n		<xsl:with-param name=\"date\" select=\"current-dateTime()\" />\r\n	</xsl:call-template>\r\n	<xsl:text>|</xsl:text>              <!-- MSH-8 Security -->\r\n	<xsl:text>|ORU^R01</xsl:text>       <!-- MSH-9 Message type ^ Event type (observation report unsolicited) -->\r\n	<xsl:text>|</xsl:text>              <!-- MSH-10 Message control ID -->\r\n	<xsl:choose>\r\n		<xsl:when test=\"header/uid\">\r\n			<xsl:value-of select=\"header/uid\" />\r\n		</xsl:when>\r\n		<xsl:otherwise>\r\n			<xsl:value-of select=\"patient/patient.patient_id\" />\r\n			<xsl:call-template name=\"hl7Timestamp\">\r\n				<xsl:with-param name=\"date\" select=\"current-dateTime()\" />\r\n			</xsl:call-template>\r\n		</xsl:otherwise>\r\n	</xsl:choose>\r\n	<xsl:text>|P</xsl:text>             <!-- MSH-11 Processing ID -->\r\n	<xsl:text>|2.5</xsl:text>           <!-- MSH-12 HL7 version -->\r\n	<xsl:text>|1</xsl:text>             <!-- MSH-13 Message sequence number -->\r\n	<xsl:text>|</xsl:text>              <!-- MSH-14 Continuation Pointer -->\r\n	<xsl:text>|</xsl:text>              <!-- MSH-15 Accept Acknowledgement Type -->\r\n	<xsl:text>|</xsl:text>              <!-- MSH-16 Application Acknowledgement Type -->\r\n	<xsl:text>|</xsl:text>              <!-- MSH-17 Country Code -->\r\n	<xsl:text>|</xsl:text>              <!-- MSH-18 Character Set -->\r\n	<xsl:text>|</xsl:text>              <!-- MSH-19 Principal Language of Message -->\r\n	<xsl:text>|</xsl:text>              <!-- MSH-20 Alternate Character Set Handling Scheme -->\r\n	<xsl:text>|</xsl:text>              <!-- MSH-21 Message Profile Identifier -->\r\n	<xsl:value-of select=\"@id\" />\r\n	<xsl:text>^</xsl:text>\r\n	<xsl:value-of select=\"$FORM-AUTHORITY\" />\r\n	<xsl:text>&#x000d;</xsl:text>\r\n\r\n	<!-- PID header -->\r\n	<xsl:text>PID</xsl:text>            <!-- Message type -->\r\n	<xsl:text>|</xsl:text>              <!-- PID-1 Set ID -->\r\n	<xsl:text>|</xsl:text>              <!-- PID-2 (deprecated) Patient ID -->\r\n	<xsl:text>|</xsl:text>              <!-- PID-3 Patient Identifier List -->\r\n	<xsl:call-template name=\"patient_id\">\r\n		<xsl:with-param name=\"pid\" select=\"patient/patient.patient_id\" />\r\n		<xsl:with-param name=\"auth\" select=\"$PATIENT-AUTHORITY\" />\r\n		<xsl:with-param name=\"type\" select=\"L\" />\r\n	</xsl:call-template>\r\n	<xsl:if test=\"patient/patient.previous_mrn and string-length(patient/patient.previous_mrn) > 0\">\r\n		<xsl:text>~</xsl:text>\r\n		<xsl:call-template name=\"patient_id\">\r\n			<xsl:with-param name=\"pid\" select=\"patient/patient.previous_mrn\" />\r\n			<xsl:with-param name=\"auth\" select=\"$PATIENT-AUTHORITY\" />\r\n			<xsl:with-param name=\"type\" select=\"PRIOR\" />\r\n		</xsl:call-template>\r\n	</xsl:if>\r\n	<!-- Additional patient identifiers -->\r\n	<!-- This example is for an MTCT-PLUS identifier used in the AMPATH project in Kenya (skipped if not present) -->\r\n	<xsl:if test=\"patient/patient.mtctplus_id and string-length(patient/patient.mtctplus_id) > 0\">\r\n		<xsl:text>~</xsl:text>\r\n		<xsl:call-template name=\"patient_id\">\r\n			<xsl:with-param name=\"pid\" select=\"patient/patient.mtctplus_id\" />\r\n			<xsl:with-param name=\"auth\" select=\"$PATIENT-AUTHORITY\" />\r\n			<xsl:with-param name=\"type\" select=\"MTCTPLUS\" />\r\n		</xsl:call-template>\r\n	</xsl:if>\r\n	<xsl:text>|</xsl:text>              <!-- PID-4 (deprecated) Alternate patient ID -->\r\n	<!-- PID-5 Patient name -->\r\n	<xsl:text>|</xsl:text>              <!-- Family name -->\r\n	<xsl:value-of select=\"patient/patient.family_name\" />\r\n	<xsl:text>^</xsl:text>              <!-- Given name -->\r\n	<xsl:value-of select=\"patient/patient.given_name\" />\r\n	<xsl:text>^</xsl:text>              <!-- Middle name -->\r\n	<xsl:value-of select=\"patient/patient.middle_name\" />\r\n	<xsl:text>|</xsl:text>              <!-- PID-6 Mother\'s maiden name -->\r\n	<xsl:text>|</xsl:text>              <!-- PID-7 Date/Time of Birth -->\r\n	<xsl:value-of select=\"patient/patient.date_of_birth\" />\r\n	<xsl:text>&#x000d;</xsl:text>       <!-- new line -->\r\n	\r\n	<!-- PV1 header -->\r\n	<xsl:text>PV1</xsl:text>            <!-- Message type -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-1 Sub ID -->\r\n	<xsl:text>|O</xsl:text>             <!-- PV1-2 Patient class (O = outpatient) -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-3 Patient location -->\r\n	<xsl:value-of select=\"encounter/encounter.location_id\" />\r\n	<xsl:text>|</xsl:text>              <!-- PV1-4 Admission type (2 = return) -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-5 Pre-Admin Number -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-6 Prior Patient Location -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-7 Attending Doctor -->\r\n	<xsl:value-of select=\"encounter/encounter.provider_id\" />\r\n	<xsl:text>|</xsl:text>              <!-- PV1-8 Referring Doctor -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-9 Consulting Doctor -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-10 Hospital Service -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-11 Temporary Location -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-12 Preadmin Test Indicator -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-13 Re-adminssion Indicator -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-14 Admit Source -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-15 Ambulatory Status -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-16 VIP Indicator -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-17 Admitting Doctor -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-18 Patient Type -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-19 Visit Number -->\r\n	<xsl:value-of select=\"encounter/encounter.encounter_id\" />\r\n	<xsl:text>|</xsl:text>              <!-- PV1-20 Financial Class -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-21 Charge Price Indicator -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-22 Courtesy Code -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-23 Credit Rating -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-24 Contract Code -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-25 Contract Effective Date -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-26 Contract Amount -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-27 Contract Period -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-28 Interest Code -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-29 Transfer to Bad Debt Code -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-30 Transfer to Bad Debt Date -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-31 Bad Debt Agency Code -->\r\n  <xsl:text>|</xsl:text>              <!-- PV1-31 Bad Debt Transfer Amount -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-33 Bad Debt Recovery Amount -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-34 Delete Account Indicator -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-35 Delete Account Date -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-36 Discharge Disposition -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-37 Discharge To Location -->\r\n	<xsl:if test=\"patient/patient.health_center\">\r\n		<xsl:value-of select=\"replace(patient/patient.health_center,\'\\^\',\'&amp;\')\" />\r\n	</xsl:if>\r\n	<xsl:text>|</xsl:text>              <!-- PV1-38 Diet Type -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-39 Servicing Facility -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-40 Bed Status -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-41 Account Status -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-42 Pending Location -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-43 Prior Temporary Location -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-44 Admit Date/Time -->\r\n	<xsl:call-template name=\"hl7Date\">\r\n		<xsl:with-param name=\"date\" select=\"encounter/encounter.encounter_datetime\" />\r\n	</xsl:call-template>\r\n	<xsl:text>|</xsl:text>              <!-- PV1-45 Discharge Date/Time -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-46 Current Patient Balance -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-47 Total Charges -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-48 Total Adjustments -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-49 Total Payments -->\r\n	<xsl:text>|</xsl:text>              <!-- PV1-50 Alternate Visit ID -->\r\n	<xsl:text>|V</xsl:text>             <!-- PV1-51 Visit Indicator -->\r\n	<xsl:text>&#x000d;</xsl:text>       <!-- new line -->\r\n\r\n	<!-- We use encounter date as the timestamp for each observation -->\r\n	<xsl:variable name=\"encounterTimestamp\">\r\n		<xsl:call-template name=\"hl7Date\">\r\n			<xsl:with-param name=\"date\" select=\"encounter/encounter.encounter_datetime\" />\r\n		</xsl:call-template>\r\n	</xsl:variable>\r\n	\r\n	<!-- ORC Common Order Segment -->\r\n	<xsl:text>ORC</xsl:text>            <!-- Message type -->\r\n	<xsl:text>|RE</xsl:text>            <!-- ORC-1 Order Control (RE = obs to follow) -->\r\n	<xsl:text>|</xsl:text>              <!-- ORC-2 Placer Order Number -->\r\n	<xsl:text>|</xsl:text>              <!-- ORC-3 Filler Order Number -->\r\n	<xsl:text>|</xsl:text>              <!-- ORC-4 Placer Group Number -->\r\n	<xsl:text>|</xsl:text>              <!-- ORC-5 Order Status -->\r\n	<xsl:text>|</xsl:text>              <!-- ORC-6 Response Flag -->\r\n	<xsl:text>|</xsl:text>              <!-- ORC-7 Quantity/Timing -->\r\n	<xsl:text>|</xsl:text>              <!-- ORC-8 Parent -->\r\n	<xsl:text>|</xsl:text>              <!-- ORC-9 Date/Time of Transaction -->\r\n	<xsl:call-template name=\"hl7Timestamp\">\r\n		<xsl:with-param name=\"date\" select=\"xs:dateTime(header/date_entered)\" />\r\n	</xsl:call-template>\r\n	<xsl:text>|</xsl:text>              <!-- ORC-10 Entered By -->\r\n	<xsl:value-of select=\"header/enterer\" />\r\n	<xsl:text>&#x000d;</xsl:text>       <!-- new line -->\r\n\r\n	<!-- Observation(s) -->\r\n	<!-- <xsl:variable name=\"obsList\" select=\"obs/*[(@openmrs_concept and value and value/text() != \'\') or *[@openmrs_concept and text()=\'true\']]\" /> -->\r\n	<xsl:variable name=\"obsList\" select=\"obs/*[(@openmrs_concept and value and value/text() != \'\') or *[@openmrs_concept and text()=\'true\']]|obs/*[not(@openmrs_concept)]/*[(@openmrs_concept and value and value/text() != \'\') or *[@openmrs_concept and text()=\'true\']]\" />\r\n	<xsl:variable name=\"obsListCount\" select=\"count($obsList)\" as=\"xs:integer\" />\r\n	<!-- Observation OBR -->\r\n	<xsl:text>OBR</xsl:text>            <!-- Message type -->\r\n	<xsl:text>|</xsl:text>              <!-- OBR-1 Set ID -->\r\n	<xsl:text>1</xsl:text>\r\n	<xsl:text>|</xsl:text>              <!-- OBR-2 Placer order number -->\r\n	<xsl:text>|</xsl:text>              <!-- OBR-3 Filler order number -->\r\n	<xsl:text>|</xsl:text>              <!-- OBR-4 OBR concept -->\r\n	<xsl:value-of select=\"obs/@openmrs_concept\" />\r\n	<xsl:text>&#x000d;</xsl:text>       <!-- new line -->\r\n\r\n	<!-- observation OBXs -->\r\n	<xsl:for-each select=\"$obsList\">\r\n		<xsl:choose>\r\n			<xsl:when test=\"value\">\r\n				<xsl:call-template name=\"obsObx\">\r\n					<xsl:with-param name=\"setId\" select=\"position()\" />\r\n					<xsl:with-param name=\"datatype\" select=\"@openmrs_datatype\" />\r\n					<xsl:with-param name=\"units\" select=\"@openmrs_units\" />\r\n					<xsl:with-param name=\"concept\" select=\"@openmrs_concept\" />\r\n					<xsl:with-param name=\"date\" select=\"date/text()\" />\r\n					<xsl:with-param name=\"time\" select=\"time/text()\" />\r\n					<xsl:with-param name=\"value\" select=\"value\" />\r\n					<xsl:with-param name=\"encounterTimestamp\" select=\"$encounterTimestamp\" />\r\n				</xsl:call-template>\r\n			</xsl:when>\r\n			<xsl:otherwise>\r\n				<xsl:variable name=\"setId\" select=\"position()\" />\r\n				<xsl:for-each select=\"*[@openmrs_concept and text() = \'true\']\">\r\n					<xsl:call-template name=\"obsObx\">\r\n						<xsl:with-param name=\"setId\" select=\"$setId\" />\r\n						<xsl:with-param name=\"subId\" select=\"concat($setId,position())\" />\r\n						<xsl:with-param name=\"datatype\" select=\"../@openmrs_datatype\" />\r\n						<xsl:with-param name=\"units\" select=\"../@openmrs_units\" />\r\n						<xsl:with-param name=\"concept\" select=\"../@openmrs_concept\" />\r\n						<xsl:with-param name=\"date\" select=\"../date/text()\" />\r\n						<xsl:with-param name=\"time\" select=\"../time/text()\" />\r\n						<xsl:with-param name=\"value\" select=\"@openmrs_concept\" />\r\n						<xsl:with-param name=\"encounterTimestamp\" select=\"$encounterTimestamp\" />\r\n					</xsl:call-template>\r\n				</xsl:for-each>\r\n			</xsl:otherwise>\r\n		</xsl:choose>\r\n	</xsl:for-each>\r\n	\r\n	<!-- Grouped observation(s) -->\r\n	<!-- <xsl:variable name=\"obsGroupList\" select=\"obs/*[@openmrs_concept and not(date) and *[(@openmrs_concept and value and value/text() != \'\') or *[@openmrs_concept and text()=\'true\']]]\" /> -->\r\n	<xsl:variable name=\"obsGroupList\" select=\"obs/*[@openmrs_concept and not(date) and *[(@openmrs_concept and value and value/text() != \'\') or *[@openmrs_concept and text()=\'true\']]]|obs/*[not(@openmrs_concept)]/*[@openmrs_concept and not(date) and *[(@openmrs_concept and value and value/text() != \'\') or *[@openmrs_concept and text()=\'true\']]]\" />\r\n	<xsl:variable name=\"obsGroupListCount\" select=\"count($obsGroupList)\" as=\"xs:integer\" />\r\n	<xsl:for-each select=\"$obsGroupList\">\r\n		<!-- Observation OBR -->\r\n		<xsl:text>OBR</xsl:text>            <!-- Message type -->\r\n		<xsl:text>|</xsl:text>              <!-- OBR-1 Set ID -->\r\n		<xsl:value-of select=\"$obsListCount + position()\" />\r\n		<xsl:text>|</xsl:text>              <!-- OBR-2 Placer order number -->\r\n		<xsl:text>|</xsl:text>              <!-- OBR-3 Filler order number -->\r\n		<xsl:text>|</xsl:text>              <!-- OBR-4 OBR concept -->\r\n		<xsl:value-of select=\"@openmrs_concept\" />\r\n		<xsl:text>&#x000d;</xsl:text>       <!-- new line -->\r\n		\r\n		<!-- Generate OBXs -->\r\n		<xsl:for-each select=\"*[(@openmrs_concept and value and value/text() != \'\') or *[@openmrs_concept and text()=\'true\']]\">\r\n			<xsl:choose>\r\n				<xsl:when test=\"value\">\r\n					<xsl:call-template name=\"obsObx\">\r\n						<xsl:with-param name=\"setId\" select=\"position()\" />\r\n						<xsl:with-param name=\"subId\" select=\"1\" />\r\n						<xsl:with-param name=\"datatype\" select=\"@openmrs_datatype\" />\r\n						<xsl:with-param name=\"units\" select=\"@openmrs_units\" />\r\n						<xsl:with-param name=\"concept\" select=\"@openmrs_concept\" />\r\n						<xsl:with-param name=\"date\" select=\"date/text()\" />\r\n						<xsl:with-param name=\"time\" select=\"time/text()\" />\r\n						<xsl:with-param name=\"value\" select=\"value\" />\r\n						<xsl:with-param name=\"encounterTimestamp\" select=\"$encounterTimestamp\" />\r\n					</xsl:call-template>\r\n				</xsl:when>\r\n				<xsl:otherwise>\r\n					<xsl:variable name=\"setId\" select=\"position()\" />\r\n					<xsl:for-each select=\"*[@openmrs_concept and text() = \'true\']\">\r\n						<xsl:call-template name=\"obsObx\">\r\n							<xsl:with-param name=\"setId\" select=\"$setId\" />\r\n							<xsl:with-param name=\"subId\" select=\"concat(\'1.\',position())\" />\r\n							<xsl:with-param name=\"datatype\" select=\"../@openmrs_datatype\" />\r\n							<xsl:with-param name=\"units\" select=\"../@openmrs_units\" />\r\n							<xsl:with-param name=\"concept\" select=\"../@openmrs_concept\" />\r\n							<xsl:with-param name=\"date\" select=\"../date/text()\" />\r\n							<xsl:with-param name=\"time\" select=\"../time/text()\" />\r\n							<xsl:with-param name=\"value\" select=\"@openmrs_concept\" />\r\n							<xsl:with-param name=\"encounterTimestamp\" select=\"$encounterTimestamp\" />\r\n						</xsl:call-template>\r\n					</xsl:for-each>\r\n				</xsl:otherwise>\r\n			</xsl:choose>\r\n		</xsl:for-each>\r\n	</xsl:for-each>\r\n\r\n	<!-- Problem list(s) -->\r\n	<xsl:variable name=\"problemList\" select=\"problem_list/*[value[text() != \'\']]\" />\r\n	<xsl:variable name=\"problemListCount\" select=\"count($problemList)\" as=\"xs:integer\" />\r\n	<xsl:if test=\"$problemList\">\r\n		<!-- Problem list OBR -->\r\n		<xsl:text>OBR</xsl:text>            <!-- Message type -->\r\n		<xsl:text>|</xsl:text>              <!-- OBR-1 Set ID -->\r\n		<xsl:value-of select=\"$obsListCount + $obsGroupListCount + 1\" />\r\n		<xsl:text>|</xsl:text>              <!-- OBR-2 Placer order number -->\r\n		<xsl:text>|</xsl:text>              <!-- OBR-3 Filler order number -->\r\n		<xsl:text>|</xsl:text>              <!-- OBR-4 OBR concept -->\r\n		<xsl:value-of select=\"problem_list/@openmrs_concept\" />\r\n		<xsl:text>&#x000d;</xsl:text>       <!-- new line -->\r\n\r\n		<!-- Problem list OBXs -->\r\n		<xsl:for-each select=\"$problemList\">\r\n			<xsl:call-template name=\"obsObx\">\r\n				<xsl:with-param name=\"setId\" select=\"position()\" />\r\n				<xsl:with-param name=\"datatype\" select=\"\'CWE\'\" />\r\n				<xsl:with-param name=\"concept\" select=\"@openmrs_concept\" />\r\n				<xsl:with-param name=\"date\" select=\"date/text()\" />\r\n				<xsl:with-param name=\"time\" select=\"time/text()\" />\r\n				<xsl:with-param name=\"value\" select=\"value\" />\r\n				<xsl:with-param name=\"encounterTimestamp\" select=\"$encounterTimestamp\" />\r\n			</xsl:call-template>		\r\n		</xsl:for-each>\r\n	</xsl:if>\r\n	\r\n	<!-- Orders -->\r\n	<xsl:variable name=\"orderList\" select=\"orders/*[*[@openmrs_concept and ((value and value/text() != \'\') or *[@openmrs_concept and text() = \'true\'])]]\" />\r\n	<xsl:variable name=\"orderListCount\" select=\"count($orderList)\" as=\"xs:integer\" />\r\n	<xsl:for-each select=\"$orderList\">\r\n		<!-- Order section OBR -->\r\n		<xsl:text>OBR</xsl:text>            <!-- Message type -->\r\n		<xsl:text>|</xsl:text>              <!-- OBR-1 Set ID -->\r\n		<xsl:value-of select=\"$obsListCount + $obsGroupListCount + $problemListCount + 1\" />\r\n		<xsl:text>|</xsl:text>              <!-- OBR-2 Placer order number -->\r\n		<xsl:text>|</xsl:text>              <!-- OBR-3 Filler order number -->\r\n		<xsl:text>|</xsl:text>              <!-- OBR-4 OBR concept -->\r\n		<xsl:value-of select=\"@openmrs_concept\" />\r\n		<xsl:text>&#x000d;</xsl:text>       <!-- new line -->\r\n	\r\n		<!-- Order OBXs -->\r\n		<xsl:for-each select=\"*[@openmrs_concept and ((value and value/text() != \'\') or *[@openmrs_concept and text() = \'true\'])]\">\r\n			<xsl:choose>\r\n				<xsl:when test=\"value\">\r\n					<xsl:call-template name=\"obsObx\">\r\n						<xsl:with-param name=\"setId\" select=\"position()\" />\r\n						<xsl:with-param name=\"datatype\" select=\"@openmrs_datatype\" />\r\n						<xsl:with-param name=\"units\" select=\"@openmrs_units\" />\r\n						<xsl:with-param name=\"concept\" select=\"@openmrs_concept\" />\r\n						<xsl:with-param name=\"date\" select=\"date/text()\" />\r\n						<xsl:with-param name=\"time\" select=\"time/text()\" />\r\n						<xsl:with-param name=\"value\" select=\"value\" />\r\n						<xsl:with-param name=\"encounterTimestamp\" select=\"$encounterTimestamp\" />\r\n					</xsl:call-template>\r\n				</xsl:when>\r\n				<xsl:otherwise>\r\n					<xsl:variable name=\"setId\" select=\"position()\" />\r\n					<xsl:for-each select=\"*[@openmrs_concept and text() = \'true\']\">\r\n						<xsl:call-template name=\"obsObx\">\r\n							<xsl:with-param name=\"setId\" select=\"$setId\" />\r\n							<xsl:with-param name=\"subId\" select=\"position()\" />\r\n							<xsl:with-param name=\"datatype\" select=\"../@openmrs_datatype\" />\r\n							<xsl:with-param name=\"units\" select=\"../@openmrs_units\" />\r\n							<xsl:with-param name=\"concept\" select=\"../@openmrs_concept\" />\r\n							<xsl:with-param name=\"date\" select=\"../date/text()\" />\r\n							<xsl:with-param name=\"time\" select=\"../time/text()\" />\r\n							<xsl:with-param name=\"value\" select=\"@openmrs_concept\" />\r\n							<xsl:with-param name=\"encounterTimestamp\" select=\"$encounterTimestamp\" />\r\n						</xsl:call-template>\r\n					</xsl:for-each>\r\n				</xsl:otherwise>\r\n			</xsl:choose>\r\n		</xsl:for-each>	\r\n	</xsl:for-each>\r\n	\r\n</xsl:template>\r\n\r\n<!-- Patient Identifier (CX) generator -->\r\n<xsl:template name=\"patient_id\">\r\n	<xsl:param name=\"pid\" />\r\n	<xsl:param name=\"auth\" />\r\n	<xsl:param name=\"type\" />\r\n	<xsl:value-of select=\"$pid\" />\r\n	<xsl:text>^</xsl:text>              <!-- Check digit -->\r\n	<xsl:text>^</xsl:text>              <!-- Check Digit Scheme -->\r\n	<xsl:text>^</xsl:text>              <!-- Assigning Authority -->\r\n	<xsl:value-of select=\"$auth\" />\r\n	<xsl:text>^</xsl:text>              <!-- Identifier Type -->\r\n	<xsl:value-of select=\"$type\" />\r\n</xsl:template>\r\n\r\n<!-- OBX Generator -->\r\n<xsl:template name=\"obsObx\">\r\n	<xsl:param name=\"setId\" required=\"no\"></xsl:param>\r\n	<xsl:param name=\"subId\" required=\"no\"></xsl:param>\r\n	<xsl:param name=\"datatype\" required=\"yes\" />\r\n	<xsl:param name=\"concept\" required=\"yes\" />\r\n	<xsl:param name=\"date\" required=\"no\"></xsl:param>\r\n	<xsl:param name=\"time\" required=\"no\"></xsl:param>\r\n	<xsl:param name=\"value\" required=\"no\"></xsl:param>\r\n	<xsl:param name=\"units\" required=\"no\"></xsl:param>\r\n	<xsl:param name=\"encounterTimestamp\" required=\"yes\" />\r\n	<xsl:text>OBX</xsl:text>                     <!-- Message type -->\r\n	<xsl:text>|</xsl:text>                       <!-- Set ID -->\r\n	<xsl:value-of select=\"$setId\" />\r\n	<xsl:text>|</xsl:text>                       <!-- Observation datatype -->\r\n	<xsl:choose>\r\n		<xsl:when test=\"$datatype = \'BIT\'\">\r\n			<xsl:text>NM</xsl:text>\r\n		</xsl:when>\r\n		<xsl:otherwise>\r\n			<xsl:value-of select=\"$datatype\" />\r\n		</xsl:otherwise>\r\n	</xsl:choose>\r\n	<xsl:text>|</xsl:text>                       <!-- Concept (what was observed -->\r\n	<xsl:value-of select=\"$concept\" />\r\n	<xsl:text>|</xsl:text>                       <!-- Sub-ID -->\r\n	<xsl:value-of select=\"$subId\" />\r\n	<xsl:text>|</xsl:text>                       <!-- Value -->\r\n	<xsl:choose>\r\n		<xsl:when test=\"$datatype = \'TS\'\">\r\n			<xsl:call-template name=\"hl7Timestamp\">\r\n				<xsl:with-param name=\"date\" select=\"$value\" />\r\n			</xsl:call-template>\r\n		</xsl:when>\r\n		<xsl:when test=\"$datatype = \'DT\'\">\r\n			<xsl:call-template name=\"hl7Date\">\r\n				<xsl:with-param name=\"date\" select=\"$value\" />\r\n			</xsl:call-template>\r\n		</xsl:when>\r\n		<xsl:when test=\"$datatype = \'TM\'\">\r\n			<xsl:call-template name=\"hl7Time\">\r\n				<xsl:with-param name=\"time\" select=\"$value\" />\r\n			</xsl:call-template>\r\n		</xsl:when>\r\n		<xsl:when test=\"$datatype = \'BIT\'\">\r\n			<xsl:choose>\r\n				<xsl:when test=\"$value = \'0\' or upper-case($value) = \'FALSE\'\">0</xsl:when>\r\n				<xsl:otherwise>1</xsl:otherwise>\r\n			</xsl:choose>\r\n		</xsl:when>\r\n		<xsl:otherwise>\r\n			<xsl:value-of select=\"$value\" />\r\n		</xsl:otherwise>\r\n	</xsl:choose>\r\n	<xsl:text>|</xsl:text>                       <!-- Units -->\r\n	<xsl:value-of select=\"$units\" />\r\n	<xsl:text>|</xsl:text>                       <!-- Reference range -->\r\n	<xsl:text>|</xsl:text>                       <!-- Abnormal flags -->\r\n	<xsl:text>|</xsl:text>                       <!-- Probability -->\r\n	<xsl:text>|</xsl:text>                       <!-- Nature of abnormal test -->\r\n	<xsl:text>|</xsl:text>                       <!-- Observation result status -->\r\n	<xsl:text>|</xsl:text>                       <!-- Effective date -->\r\n	<xsl:text>|</xsl:text>                       <!-- User defined access checks -->\r\n	<xsl:text>|</xsl:text>                       <!-- Date time of observation -->\r\n	<xsl:choose>\r\n		<xsl:when test=\"$date and $time\">\r\n			<xsl:call-template name=\"hl7Timestamp\">\r\n				<xsl:with-param name=\"date\" select=\"dateTime($date,$time)\" />\r\n			</xsl:call-template>\r\n		</xsl:when>\r\n		<xsl:when test=\"$date\">\r\n			<xsl:call-template name=\"hl7Date\">\r\n				<xsl:with-param name=\"date\" select=\"$date\" />\r\n			</xsl:call-template>\r\n		</xsl:when>\r\n		<xsl:otherwise>\r\n			<xsl:value-of select=\"$encounterTimestamp\" />\r\n		</xsl:otherwise>\r\n	</xsl:choose>\r\n	<xsl:text>&#x000d;</xsl:text>\r\n</xsl:template>\r\n\r\n<!-- Generate HL7-formatted timestamp -->\r\n<xsl:template name=\"hl7Timestamp\">\r\n	<xsl:param name=\"date\" />\r\n	<xsl:if test=\"string($date) != \'\'\">\r\n		<xsl:value-of select=\"concat(year-from-dateTime($date),format-number(month-from-dateTime($date),\'00\'),format-number(day-from-dateTime($date),\'00\'),format-number(hours-from-dateTime($date),\'00\'),format-number(minutes-from-dateTime($date),\'00\'),format-number(floor(seconds-from-dateTime($date)),\'00\'))\" />\r\n	</xsl:if>\r\n</xsl:template>\r\n\r\n<!-- Generate HL7-formatted date -->\r\n<xsl:template name=\"hl7Date\">\r\n	<xsl:param name=\"date\" />\r\n	<xsl:if test=\"string($date) != \'\'\">\r\n		<xsl:choose>\r\n			<xsl:when test=\"contains(string($date),\'T\')\">\r\n				<xsl:call-template name=\"hl7Date\">\r\n					<xsl:with-param name=\"date\" select=\"xs:date(substring-before($date,\'T\'))\" />\r\n				</xsl:call-template>\r\n			</xsl:when>\r\n			<xsl:otherwise>\r\n					<xsl:value-of select=\"concat(year-from-date($date),format-number(month-from-date($date),\'00\'),format-number(day-from-date($date),\'00\'))\" />\r\n			</xsl:otherwise>\r\n		</xsl:choose>				\r\n	</xsl:if>\r\n</xsl:template>\r\n\r\n<!-- Generate HL7-formatted time -->\r\n<xsl:template name=\"hl7Time\">\r\n	<xsl:param name=\"time\" />\r\n	<xsl:if test=\"$time != \'\'\">\r\n		<xsl:value-of select=\"concat(format-number(hours-from-time($time),\'00\'),format-number(minutes-from-time($time),\'00\'),format-number(floor(seconds-from-time($time)),\'00\'))\" />\r\n	</xsl:if>\r\n</xsl:template>\r\n\r\n</xsl:stylesheet>'
				WHERE xslt LIKE '%\r\n@version 1.9.6\r\n%';
			]]>
		</sql>
	
	</changeSet>
	
	<changeSet id="20090122-0853" author="bwolfe">
		<preConditions onFail="CONTINUE">
			<not><dbms type="hsql" /></not> <!-- skip over this changeset in unit tests -->
		</preConditions>
		<comment>
			Remove duplicate concept name tags
		</comment>
		
		<sql>
			UPDATE 
				concept_name_tag_map map 
			SET 
				concept_name_tag_id = (SELECT 
										 min(concept_name_tag_id)
									   FROM concept_name_tag
									   WHERE 
									     tag = (select tag from concept_name_tag where concept_name_tag_id = map.concept_name_tag_id)
									  );
		</sql>
		
		<!-- Copy the concept_name_map_ids to a new table -->
		<addLookupTable
			existingTableName="concept_name_tag" existingColumnName="concept_name_tag_id"
			newTableName="tmp_concept_name_tag_duplicates" newColumnName="concept_name_tag_id" 
			newColumnDataType="int" constraintName="concept_name_tag_ids_dupes"
		/>
		
		<dropForeignKeyConstraint
			constraintName="concept_name_tag_ids_dupes"
			baseTableName="concept_name_tag" />
		
		<!-- Leave only ids that have duplicates in the table -->
		<delete tableName="tmp_concept_name_tag_duplicates">
			<where>concept_name_tag_id not in (select concept_name_tag_id from concept_name_tag where tag in (select tag from concept_name_tag group by tag having count(*) > 1))</where>
		</delete>
		
		<!-- Now delete all  -->
		<delete tableName="concept_name_tag">
			<where>
				concept_name_tag_id in (select concept_name_tag_id from tmp_concept_name_tag_duplicates)
				and
				concept_name_tag_id not in (select distinct(concept_name_tag_id) from concept_name_tag_map)
			</where>
		</delete>
		
		<dropTable tableName="tmp_concept_name_tag_duplicates" />
		
	</changeSet>
	
	<changeSet id="20090123-0305" author="bwolfe">
		<preConditions onFail="MARK_RAN">
			<not>
				<indexExists indexName="concept_name_tag_unique_tags" />
			</not>
		</preConditions>
		<comment>
			Add unique constraint to the tags table
		</comment>
		
		<addUniqueConstraint tableName="concept_name_tag" columnNames="tag" constraintName="concept_name_tag_unique_tags"/>
		
	</changeSet>
	
	<changeSet id="20090224-1229" author="Keelhaul+bwolfe">
		<comment>
			Add location tags table
		</comment>
		
		<createTable tableName="location_tag">
			<column name="location_tag_id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="name" type="varchar(50)">
				<constraints nullable="false"/>
			</column>
			<column name="description" type="varchar(255)" defaultValue="null"/>
			<column name="creator" type="int(11)" >
				<constraints nullable="false" />
			</column>
			<column name="date_created" type="datetime" >
				<constraints nullable="false"/>
			</column>
			<column name="retired" type="tinyint" defaultValueNumeric="0">
				<constraints nullable="false"/>
			</column>
			<column name="retired_by" type="int(11)" />
			<column name="date_retired" type="datetime" />
			<column name="retired_reason" type="varchar(255)" defaultValue="null"/>
		</createTable>
		
		<addForeignKeyConstraint constraintName="location_tag_creator"
			baseTableName="location_tag" baseColumnNames="creator"
			referencedTableName="users" referencedColumnNames="user_id"
			/>
		<addForeignKeyConstraint constraintName="location_tag_retired_by"
			baseTableName="location_tag" baseColumnNames="retired_by"
			referencedTableName="users" referencedColumnNames="user_id"
			/>
	</changeSet>
	
	<changeSet id="20090224-1250" author="Keelhaul+bwolfe">
		<comment>
			Add location tag map table
		</comment>
		
		<createTable tableName="location_tag_map">
			<column name="location_id" type="int">
				<constraints nullable="false"/>
			</column>
			<column name="location_tag_id" type="int">
				<constraints nullable="false"/>
			</column>
		</createTable>
		
		<addForeignKeyConstraint constraintName="location_tag_map_location"
			baseTableName="location_tag_map" baseColumnNames="location_id"
			referencedTableName="location" referencedColumnNames="location_id"
			/>
	    <addForeignKeyConstraint constraintName="location_tag_map_tag"
			baseTableName="location_tag_map" baseColumnNames="location_tag_id"
			referencedTableName="location_tag" referencedColumnNames="location_tag_id"
			/>
		<addPrimaryKey tableName="location_tag_map"
			columnNames="location_id,location_tag_id"
			constraintName="key_for_location_tag_map"/>
		
	</changeSet>
	
	<changeSet id="20090224-1256" author="Keelhaul+bwolfe">
		<comment>
			Add parent_location column to location table
		</comment>
		
		<addColumn tableName="location">
			<column name="parent_location" type="int(11)" />
		</addColumn>
		
		<addForeignKeyConstraint constraintName="parent_location"
			baseTableName="location" baseColumnNames="parent_location"
			referencedTableName="location" referencedColumnNames="location_id"
			/>
	</changeSet>
	
	<changeSet id="20090225-1551" author="dthomas">
		<comment>
			Change location_tag.name to location_tag.tag and location_tag.retired_reason to location_tag.retire_reason
		</comment>
		<renameColumn tableName="location_tag"
   			 oldColumnName="name" newColumnName="tag" columnDataType="varchar(50)"/>
		<renameColumn tableName="location_tag"
   			 oldColumnName="retired_reason" newColumnName="retire_reason" columnDataType="varchar(255)"/>
	</changeSet>

	<changeSet id="02232009-1141" author="nribeka">
		<comment>
			Modify the password column to fit the output of SHA-512 function
		</comment>
		
		<modifyColumn tableName="users">
			<column name="password" type="varchar(128)"/>
			<column name="salt" type="varchar(128)"/>
		</modifyColumn>
	</changeSet>	
	
	<changeSet id="20090301-1259" author="bwolfe">
		<comment>
			Fixes the description for name layout global property
		</comment>
		
		<update tableName="global_property">
			<column name="description" value="Format in which to display the person names.  Valid values are short, long"/>
			<where>property='layout.name.format'</where>
		</update>
		<update tableName="global_property">
			<column name="property_value" value="short"/>
			<where>property='layout.name.format' and property_value='Format in which to display the person names.  Valid values are short, long'</where>
		</update>
		
	</changeSet>
	
	<changeSet id="20090214-2246" author="isherman">
		<preConditions onFail="MARK_RAN">
			<dbms type="mysql" />
		</preConditions>
		<comment>
			Add weight and cd4 to patientGraphConcepts user property (mysql specific)
		</comment>
		
		<sql>
			UPDATE user_property
				SET property_value = CONCAT(
					'-', 
					(SELECT property_value FROM global_property WHERE property = 'concept.weight'),
					'-',
					(SELECT property_value FROM global_property WHERE property = 'concept.cd4_count'),
					property_value
				) WHERE property = 'patientGraphConcepts';			
		</sql>
	</changeSet>
	
	<changeSet id="20090214-2247" author="isherman">
		<preConditions onFail="MARK_RAN">
			<or>
				<dbms type="postgresql" />
				<dbms type="oracle" />
				<dbms type="db2" />
			</or>
		</preConditions>
		<comment>
			Add weight and cd4 to patientGraphConcepts user property (using standard sql)
		</comment>
		
		<sql>
			UPDATE user_property
				SET property_value = 
					'-' || 
					(SELECT property_value FROM global_property WHERE property = 'concept.weight') ||
					'-' ||
					(SELECT property_value FROM global_property WHERE property = 'concept.cd4_count') ||
					property_value
				) WHERE property = 'patientGraphConcepts';			
		</sql>
	</changeSet>
	
	<changeSet id="20090214-2248" author="isherman">
		<preConditions onFail="MARK_RAN">
			<dbms type="mssql" />
		</preConditions>
		<comment>
			Add weight and cd4 to patientGraphConcepts user property (mssql specific)
		</comment>
		
		<sql>
			UPDATE user_property
				SET property_value = 
					'-' + 
					(SELECT property_value FROM global_property WHERE property = 'concept.weight') +
					'-' +
					(SELECT property_value FROM global_property WHERE property = 'concept.cd4_count') +
					property_value
				) WHERE property = 'patientGraphConcepts';			
		</sql>
	</changeSet>
	
	<changeSet id="20090316-1008" author="vanand">
		<validCheckSum>cf32d07af2933e9a3555395737b5142</validCheckSum><!-- old checksum before adding in person.birthdate_estimated cleanup -->
		<validCheckSum>fcdde237e04473db1e6fd16f56bf80e9</validCheckSum><!-- new checksum after adding in person.birthdate_estimated cleanup -->
		<comment>
			Change column types of all boolean columns to smallint. The columns used to be either tinyint(4) or MySQL's BIT.
			(This may take a while on large patient or obs tables)
		</comment>
		
		<modifyColumn tableName="cohort">
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="concept">
			<column name="retired" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="is_set" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="concept_class">
			<column name="retired" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="concept_datatype">
			<column name="retired" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="concept_name">
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="concept_name_tag">
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="concept_numeric">
			<column name="precise" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<update tableName="concept_source">
			<column name="voided" value="0" />
			<where>voided is null</where>
		</update>
		<modifyColumn tableName="concept_source">
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="drug">
			<column name="combination" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="retired" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="drug_order">
			<column name="prn" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="complex" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="encounter">
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="encounter_type">
			<column name="retired" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="field">
			<column name="select_multiple" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="retired" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="field_type">
			<column name="is_set" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="form">
			<column name="published" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="retired" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>		
		<modifyColumn tableName="form_field">
			<column name="required" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>		
		<modifyColumn tableName="location_tag">
			<column name="retired" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>		
		<modifyColumn tableName="obs">
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>		
		<modifyColumn tableName="order_type">
			<column name="retired" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="orders">
			<column name="discontinued" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="patient">
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="patient_identifier">
			<column name="preferred" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="patient_identifier_type">
			<column name="check_digit" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="required" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="retired" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="patient_program">
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="patient_state">
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<update tableName="person">
			<column name="birthdate_estimated" value="0" />
			<where>birthdate_estimated is null</where>
		</update>
		<modifyColumn tableName="person">
			<column name="birthdate_estimated" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="dead" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="person_address">
			<column name="preferred" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="person_attribute">
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="person_attribute_type">
			<column name="searchable" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="retired" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="person_name">
			<column name="preferred" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="program">
			<column name="retired" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="program_workflow">
			<column name="retired" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="program_workflow_state">
			<column name="initial" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="terminal" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="retired" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="relationship">
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="report_object">
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
		<modifyColumn tableName="users">
			<column name="voided" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
		</modifyColumn>
	</changeSet>
	
	<changeSet id="200903210905" author="mseaton">
		<preConditions onFail="MARK_RAN">
			<not><tableExists tableName="serialized_object"/></not>
		</preConditions>
		<comment>
			Add a table to enable generic storage of serialized objects
		</comment>		
		<createTable tableName="serialized_object">
			<column name="serialized_object_id" type="int" autoIncrement="true">
				<constraints nullable="false" primaryKey="true"/>
			</column>			
			<column name="name" type="varchar(255)">
				<constraints nullable="false"/>
			</column>
			<column name="description" type="varchar(5000)"/>
			<column name="type" type="varchar(255)">
				<constraints nullable="false"/>
			</column>
			<column name="subtype" type="varchar(255)">
				<constraints nullable="false"/>
			</column>
			<column name="serialization_class" type="varchar(255)">
				<constraints nullable="false"/>
			</column>
			<column name="serialized_data" type="text">
				<constraints nullable="false"/>
			</column>
			<column name="date_created" type="DATETIME">
				<constraints nullable="false"/>
			</column>
			<column name="creator" type="int">
				<constraints nullable="false"/>
			</column>
			<column name="date_changed" type="DATETIME" />
			<column name="changed_by" type="int"/>
			<column name="retired" type="smallint" defaultValueNumeric="0">
				<constraints nullable="false"/>
			</column>
			<column name="date_retired" type="DATETIME"/>
			<column name="retired_by" type="int"/>
			<column name="retire_reason" type="varchar(1000)"/>
		</createTable>

		<addForeignKeyConstraint constraintName="serialized_object_creator" 
								 baseTableName="serialized_object" baseColumnNames="creator"
								 referencedTableName="users" referencedColumnNames="user_id"
		/>
		<addForeignKeyConstraint constraintName="serialized_object_changed_by" 
								 baseTableName="serialized_object" baseColumnNames="changed_by"
								 referencedTableName="users" referencedColumnNames="user_id"
		/>
		<addForeignKeyConstraint constraintName="serialized_object_retired_by" 
								 baseTableName="serialized_object" baseColumnNames="retired_by"
								 referencedTableName="users" referencedColumnNames="user_id"
		/>
	</changeSet>
	
	<changeSet id="200904091023" author="bwolfe">
		<comment>
			Remove Manage Tribes and View Tribes privileges from the privilege table and role_privilege table.
			The privileges will be recreated by the Tribe module if it is installed.
		</comment>
		
		<delete tableName="role_privilege">
			<where>privilege='Manage Tribes'</where>
		</delete>
		
		<delete tableName="role_privilege">
			<where>privilege='View Tribes'</where>
		</delete>
		
		<delete tableName="privilege">
			<where>privilege='Manage Tribes'</where>
		</delete>
		
		<delete tableName="privilege">
			<where>privilege='View Tribes'</where>
		</delete>
	</changeSet>
	
	<changeSet author="Cory McCarthy" id="20090408-1298">
		<comment>Changed the datatype for encounter_type to 'text' instead of just 50 chars</comment>
		<modifyColumn tableName="encounter_type">
			<column name="description" type="text" />
		</modifyColumn>
	</changeSet>
	
	<changeSet id="200905150814" author="bwolfe">
		<comment>Deleting invalid concept words</comment>
		<delete tableName="concept_word">
			<where>concept_name_id = 0</where>
		</delete>
	</changeSet>
	
	<changeSet id="200905150821" author="bwolfe">
		<comment>Deleting duplicate concept word keys</comment>
		<sql>delete from concept_word group by concept_id, word, locale having count(*) > 1 and min(concept_name_id)</sql>
	</changeSet>
	
	<changeSet id="200904271042" author="bwolfe">
		<comment>Remove the now unused synonym column</comment>
		<dropColumn tableName="concept_word" columnName="synonym"/>
	</changeSet>
	
	<changeSet id="200905071626" author="bwolfe" failOnError="false">
		<preConditions onFail="MARK_RAN">
			<not>
				<indexExists indexName="concept_word_concept_idx"/>
			</not>
		</preConditions>
	
		<comment>
			Add an index to the concept_word.concept_id column (This update may fail if it already exists)
		</comment>
		
		<createIndex tableName="concept_word" indexName="concept_word_concept_idx">
			<column name="concept_id" />
		</createIndex>
	</changeSet>
		
	<changeSet id="200904271654" author="bwolfe">
		<validCheckSum>31e2cec595288b267cc3e3cfb083</validCheckSum>
		<validCheckSum>44c812f4360353c5ffc5d5c1473bcf</validCheckSum>
		<preConditions onFail="MARK_RAN">
			<not>
				<!-- uuid branch devs and users of sync branch already have an updated concept_word integer primary key -->
				<columnExists tableName="concept_word" columnName="concept_word_id"/>
			</not>
		</preConditions>
		
		<comment>
			Change the concept_word key to be concept_name_id-word-locale
		</comment>
		
		<dropPrimaryKey tableName="concept_word"/>
		
		<addPrimaryKey tableName="concept_word" columnNames="concept_name_id,word,locale"/>
	</changeSet>
	
	<changeSet id="20090402-1515" author="bwolfe">
		<comment>
			Adding "uuid" column to all tables.  (This may take a while on large databases)
		</comment>
		
		<!-- "UUID" is translated by liquibase into the appropriate column type -->
		
		<addColumn tableName="cohort">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="concept">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="concept_answer">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="concept_class">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="concept_datatype">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="concept_description">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="concept_map">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="concept_name">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="concept_name_tag">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="concept_proposal">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="concept_set">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="concept_source">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="concept_state_conversion">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="drug">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="encounter">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="encounter_type">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="field">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="field_answer">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="field_type">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="form">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="form_field">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="global_property">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="hl7_in_archive">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="hl7_in_error">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="hl7_in_queue">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="hl7_source">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="location">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="location_tag">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="note">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="notification_alert">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="notification_template">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="obs">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="order_type">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="orders">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="patient_identifier">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="patient_identifier_type">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="patient_program">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="patient_state">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="person">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="person_address">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="person_attribute">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="person_attribute_type">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="person_name">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="privilege">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="program">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="program_workflow">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="program_workflow_state">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="relationship">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="relationship_type">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="report_object">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="report_schema_xml">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="role">
			<column name="uuid" type="UUID" />
		</addColumn>
		<addColumn tableName="serialized_object">
			<column name="uuid" type="UUID" />
		</addColumn>
	</changeSet>

	<changeSet id="20090402-1516" author="bwolfe">
		<preConditions onFail="MARK_RAN">
			<or>
				<dbms type="mysql" />
				<dbms type="oracle" />
				<dbms type="mssql" />
			</or>
		</preConditions>
		<comment>
			Generating UUIDs for all rows in all tables via built in uuid function. (This may take a while on large databases)
		</comment>
		
		<update tableName="cohort" >
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="concept">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="concept_answer">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="concept_class">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="concept_datatype">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="concept_description">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="concept_map">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="concept_name">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="concept_name_tag">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="concept_proposal">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="concept_set">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="concept_source">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="concept_state_conversion">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="drug">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="encounter">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="encounter_type">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="field">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="field_answer">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="field_type">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="form">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="form_field">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="global_property">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="hl7_in_archive">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="hl7_in_error">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="hl7_in_queue">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="hl7_source">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="location">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="location_tag">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="note">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="notification_alert">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="notification_template">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="obs">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="order_type">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="orders">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="patient_identifier">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="patient_identifier_type">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="patient_program">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="patient_state">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="person">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="person_address">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="person_attribute">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="person_attribute_type">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="person_name">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="privilege">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="program">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="program_workflow">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="program_workflow_state">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="relationship">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="relationship_type">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="report_object">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="report_schema_xml">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="role">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<update tableName="serialized_object">
			<column name="uuid" valueNumeric="name-of-uuid-function" />
		</update>
		<modifySql dbms="mysql">
			<replace replace="name-of-uuid-function" with="UUID()"/>
		</modifySql>
		<modifySql dbms="oracle">
			<replace replace="name-of-uuid-function" with="SYS_GUID()"/>
		</modifySql>
		<modifySql dbms="mssql">
			<replace replace="name-of-uuid-function" with="NEWSEQUENTIALID()"/>
		</modifySql>		
	</changeSet>
	
	<changeSet id="20090402-1517" author="bwolfe">
		<preConditions onFail="MARK_RAN">
			<not>
				<or>
					<dbms type="mysql" />
					<dbms type="oracle" />
					<dbms type="mssql" />
				</or>
			</not>
		</preConditions>
		<comment>
			Adding UUIDs to all rows in all columns via a java class.
		</comment>
		<customChange class="org.openmrs.util.databasechange.GenerateUuid">
			<param name="tableNames">
				cohort concept concept_answer concept_class concept_datatype concept_description 
				concept_map concept_name concept_name_tag concept_proposal
				concept_set concept_source concept_state_conversion concept_synonym drug
				encounter encounter_type field field_answer field_type form form_field global_property hl7_in_archive 
				hl7_in_error hl7_in_queue hl7_source location location_tag note notification_alert 
				notification_template obs order_type orders patient_identifier 
				patient_identifier_type patient_program patient_state person person_address person_attribute 
				person_attribute_type person_name privilege program program_workflow program_workflow_state relationship 
				relationship_type report_object report_schema_xml role serialized_object
			</param>
			<param name="columnName" value="uuid"/>
		</customChange>
	</changeSet>
	
	<changeSet id="20090402-1518" author="bwolfe">
		<comment>
			Now that UUID generation is done, set the uuid columns to not "NOT NULL" 
		</comment>
		
		<addNotNullConstraint tableName="cohort" columnName="uuid" columnDataType="UUID"/>
		<addNotNullConstraint tableName="concept" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="concept_answer" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="concept_class" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="concept_datatype" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="concept_description" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="concept_map" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="concept_name" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="concept_name_tag" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="concept_proposal" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="concept_set" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="concept_source" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="concept_state_conversion" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="drug" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="encounter" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="encounter_type" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="field" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="field_answer" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="field_type" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="form" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="form_field" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="global_property" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="hl7_in_archive" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="hl7_in_error" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="hl7_in_queue" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="hl7_source" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="location" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="location_tag" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="note" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="notification_alert" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="notification_template" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="obs" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="order_type" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="orders" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="patient_identifier" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="patient_identifier_type" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="patient_program" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="patient_state" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="person" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="person_address" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="person_attribute" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="person_attribute_type" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="person_name" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="privilege" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="program" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="program_workflow" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="program_workflow_state" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="relationship_type" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="report_object" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="report_schema_xml" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="role" columnName="uuid" columnDataType="UUID" />
		<addNotNullConstraint tableName="serialized_object" columnName="uuid" columnDataType="UUID" />
	</changeSet>
	
	<changeSet id="20090402-1519" author="bwolfe">
		<comment>
			Creating unique index on all uuid columns on all tables. This will take a long time on large databases.
		</comment>
		
		<createIndex tableName="cohort" unique="true" indexName="cohort_uuid_index" >
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="concept" unique="true" indexName="concept_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="concept_answer" unique="true" indexName="concept_answer_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="concept_class" unique="true" indexName="concept_class_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="concept_datatype" unique="true" indexName="concept_datatype_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="concept_description" unique="true" indexName="concept_description_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="concept_map" unique="true" indexName="concept_map_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="concept_name" unique="true" indexName="concept_name_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="concept_name_tag" unique="true" indexName="concept_name_tag_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="concept_proposal" unique="true" indexName="concept_proposal_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="concept_set" unique="true" indexName="concept_set_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="concept_source" unique="true" indexName="concept_source_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="concept_state_conversion" unique="true" indexName="concept_state_conversion_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="drug" unique="true" indexName="drug_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="encounter" unique="true" indexName="encounter_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="encounter_type" unique="true" indexName="encounter_type_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="field" unique="true" indexName="field_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="field_answer" unique="true" indexName="field_answer_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="field_type" unique="true" indexName="field_type_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="form" unique="true" indexName="form_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="form_field" unique="true" indexName="form_field_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="global_property" unique="true" indexName="global_property_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="hl7_in_archive" unique="true" indexName="hl7_in_archive_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="hl7_in_error" unique="true" indexName="hl7_in_error_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="hl7_in_queue" unique="true" indexName="hl7_in_queue_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="hl7_source" unique="true" indexName="hl7_source_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="location" unique="true" indexName="location_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="location_tag" unique="true" indexName="location_tag_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="note" unique="true" indexName="note_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="notification_alert" unique="true" indexName="notification_alert_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="notification_template" unique="true" indexName="notification_template_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="obs" unique="true" indexName="obs_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="order_type" unique="true" indexName="order_type_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="orders" unique="true" indexName="orders_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="patient_identifier" unique="true" indexName="patient_identifier_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="patient_identifier_type" unique="true" indexName="patient_identifier_type_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="patient_program" unique="true" indexName="patient_program_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="patient_state" unique="true" indexName="patient_state_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="person" unique="true" indexName="person_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="person_address" unique="true" indexName="person_address_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="person_attribute" unique="true" indexName="person_attribute_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="person_attribute_type" unique="true" indexName="person_attribute_type_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="person_name" unique="true" indexName="person_name_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="privilege" unique="true" indexName="privilege_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="program" unique="true" indexName="program_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="program_workflow" unique="true" indexName="program_workflow_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="program_workflow_state" unique="true" indexName="program_workflow_state_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="relationship" unique="true" indexName="relationship_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="relationship_type" unique="true" indexName="relationship_type_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="report_object" unique="true" indexName="report_object_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="report_schema_xml" unique="true" indexName="report_schema_xml_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="role" unique="true" indexName="role_uuid_index">
			<column name="uuid" />
		</createIndex>
		<createIndex tableName="serialized_object" unique="true" indexName="serialized_object_uuid_index">
			<column name="uuid" />
		</createIndex>
	</changeSet>
	
	<changeSet id="20090414-0804" author="bwolfe">
		<preConditions onFail="MARK_RAN">
			<foreignKeyConstraintExists foreignKeyName="is_a" />
		</preConditions>
		<comment>Dropping foreign key on concept_set.concept_id table</comment>
		<dropForeignKeyConstraint baseTableName="concept_set" constraintName="is_a" />
	</changeSet>
	
	<changeSet id="20090414-0805" author="bwolfe">
		<comment>Dropping primary key on concept set table</comment>
		<dropPrimaryKey tableName="concept_set" />
	</changeSet>
	
	<changeSet id="20090414-0806" author="bwolfe">
		<comment>Adding new integer primary key to concept set table</comment>
		<addColumn tableName="concept_set">
			<column name="concept_set_id" type="int(11)" autoIncrement="true">
				<constraints nullable="false" primaryKey="true" primaryKeyName="concept_set_pk" 
							 unique="true" uniqueConstraintName="concept_set_id_unique" />
			</column>
		</addColumn>
		<modifySql dbms="mysql">
			<append value=" FIRST" />
		</modifySql>
	</changeSet>
	
	<changeSet id="20090414-0807" author="bwolfe">
		<comment>Adding index and foreign key to concept_set.concept_id column</comment>
		<createIndex tableName="concept_set" indexName="idx_concept_set_concept">
			<column name="concept_id"/>
		</createIndex>
		<addForeignKeyConstraint baseTableName="concept_set" baseColumnNames="concept_id" constraintName="is_a" referencedTableName="concept" referencedColumnNames="concept_id" />
	</changeSet>
	
	<changeSet id="20090414-0808a" author="bwolfe">
		<preConditions onFail="MARK_RAN">
			<foreignKeyConstraintExists foreignKeyName="identifies_patient" />
		</preConditions>
		<comment>Dropping foreign key on patient_identifier.patient_id column</comment>
		<dropForeignKeyConstraint baseTableName="patient_identifier" constraintName="identifies_patient" />
	</changeSet>
	
	<changeSet id="20090414-0808b" author="bwolfe">
		<comment>Dropping non-integer primary key on patient identifier table before adding a new integer primary key</comment> 
		<dropPrimaryKey tableName="patient_identifier" />
	</changeSet>
	
	<changeSet id="20090414-0809" author="bwolfe">
		<comment>Adding new integer primary key to patient identifier table</comment>
		<addColumn tableName="patient_identifier">
			<column name="patient_identifier_id" type="int(11)" autoIncrement="true">
				<constraints nullable="false" primaryKey="true" primaryKeyName="patient_identifier_pk" 
							 unique="true" uniqueConstraintName="patient_identifier_id_unique" />
			</column>
		</addColumn>
		<modifySql dbms="mysql">
			<append value=" FIRST" />
		</modifySql>
	</changeSet>

	<changeSet id="20090414-0810" author="bwolfe">
		<comment>Adding index and foreign key on patient_identifier.patient_id column</comment>
		<createIndex tableName="patient_identifier" indexName="idx_patient_identifier_patient">
			<column name="patient_id"/>
		</createIndex>
		<addForeignKeyConstraint baseTableName="patient_identifier" baseColumnNames="patient_id" constraintName="identifies_patient" referencedTableName="patient" referencedColumnNames="patient_id" />
	</changeSet>
	
	<changeSet id="20090414-0811a" author="bwolfe">
		<preConditions onFail="MARK_RAN">
			<foreignKeyConstraintExists foreignKeyName="word_for" />
		</preConditions>
		<comment>Dropping foreign key on concept_word.concept_id column</comment>
		<dropForeignKeyConstraint baseTableName="concept_word" constraintName="word_for" />
	</changeSet>
	
	<changeSet id="20090428-0811aa" author="bwolfe" failOnError="false">
		<comment>Removing concept_word.concept_name_id foreign key so that primary key can be changed to concept_word_id</comment>
		<dropForeignKeyConstraint baseTableName="concept_word" constraintName="word_for_name" />
	</changeSet>
	
	<changeSet id="20090414-0811b" author="bwolfe">
		<comment>Dropping non-integer primary key on concept word table before adding new integer one</comment>
		<dropPrimaryKey tableName="concept_word" />
	</changeSet>
	
	<changeSet id="20090414-0812" author="bwolfe">
		<comment>Adding integer primary key to concept word table</comment>
		<addColumn tableName="concept_word">
			<column name="concept_word_id" type="int(11)" autoIncrement="true">
				<constraints nullable="false" primaryKey="true" primaryKeyName="concept_word_pk" 
							 unique="true" uniqueConstraintName="concept_word_id_unique" />
			</column>
		</addColumn>
		<modifySql dbms="mysql">
			<append value=" FIRST" />
		</modifySql>
	</changeSet>
	
	<changeSet id="20090414-0812b" author="bwolfe">
		<comment>Re-adding foreign key for concept_word.concept_name_id</comment>
		<addForeignKeyConstraint baseTableName="concept_word" baseColumnNames="concept_name_id" constraintName="word_for_name" referencedTableName="concept_name" referencedColumnNames="concept_name_id"/>
	</changeSet>
	
	<changeSet id="20090428-0854" author="bwolfe">
		<preConditions onFail="MARK_RAN">
			<not>
				<foreignKeyConstraintExists foreignKeyName="word_for"/>
			</not>
		</preConditions>
		<comment>Adding foreign key for concept_word.concept_id column</comment>
		<addForeignKeyConstraint baseTableName="concept_word" baseColumnNames="concept_id" constraintName="word_for" referencedTableName="concept" referencedColumnNames="concept_id" />
	</changeSet>
	
</databaseChangeLog>
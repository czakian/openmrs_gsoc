<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
	"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="org.openmrs.Order">

<!-- ************************************************************ -->
<!-- ** Creation                                               ** -->
<!-- ************************************************************ -->

<insert id="createOrder" parameterClass="org.openmrs.Order">
	INSERT INTO orders
		(
		order_type_id,
		concept_id,
		orderer,
		encounter_id,
		instructions,
		start_date,
		auto_expire_date,
		creator,
		date_created
		)
	VALUES
		(
		#orderType.orderTypeId#,
		#concept.conceptId#,
		#orderer.userId#,
		#encounter.encounterId#,
		#instructions#,
		#startDate#,
		#autoExpireDate#,
		#creator.userId#,
		NOW()
		);
	<selectKey keyProperty="orderId">
		SELECT LAST_INSERT_ID() AS orderId
	</selectKey>
</insert>

<!-- ************************************************************ -->
<!-- ** Read                                                   ** -->
<!-- ************************************************************ -->

<resultMap id="orderResult" class="org.openmrs.Order">
	<result property="orderId" column="order_id" />
	<result property="orderType" column="order_type_id" select="getOrderType" />
	<result property="concept" column="concept_id" select="getConcept" />
	<result property="orderer" column="orderer" select="getUser" />
	<result property="encounter" column="encounter_id" select="getEncounter" />
	<result property="instructions" column="instructions" />
	<result property="startDate" column="start_date" />
	<result property="autoExpireDate" column="auto_expire_date" />
	<result property="creator" column="creator" select="getUser" />
	<result property="dateCreated" column="date_created" />
	<result property="discontinued" column="discontinued" nullValue="false" />
	<result property="discontinuedBy" column="discontinued_by" select="getUser" />
	<result property="discontinuedDate" column="discontinued_date" />
	<result property="discontinuedReason" column="discontinued_reason" />
	<result property="voided" column="voided" nullValue="false" />
	<result property="voidedBy" column="voided_by" select="getUser" />
	<result property="voidReason" column="void_reason" />
	<result property="dateVoided" column="void_date" />
</resultMap>

<select id="getOrder" parameterClass="int"
        resultMap="orderResult">
	SELECT * FROM orders WHERE order_id = #value#
</select>

<select id="getOrderByEncounterId" parameterClass="int" resultMap="orderResult">
	SELECT * FROM orders WHERE encounter_id = #value#
</select>

<!-- ************************************************************ -->
<!-- ** Update                                                 ** -->
<!-- ************************************************************ -->

<update id="updateOrder" parameterClass="org.openmrs.Order">
	UPDATE
		orders
	SET
		order_type_id = #orderType.orderTypeId#,
		concept_id = #concept.conceptId#,
		orderer = #orderer.userId#,
		encounter_id = #encounter.encounterId#,
		instructions = #instructions#,
		start_date = #startDate#,
		auto_expire_date = #autoExpireDate#
	WHERE
		order_id = #orderId#
</update>

<!-- ************************************************************ -->
<!-- ** Deletion                                               ** -->
<!-- ************************************************************ -->

<delete id="deleteOrder" parameterClass="int">
	DELETE FROM orders WHERE order_id = #value#
</delete>

<update id="discontinueOrder" parameterClass="org.openmrs.Order">
	UPDATE
		orders
	SET
		discontinued = 1,
		discontinued_by = #discontinuedBy.userId#,
		discontinued_date = NOW(),
		discontinued_reason = #discontinuedReason#
	WHERE
		order_id = #orderId#
</update>

<update id="undiscontinueOrder" parameterClass="org.openmrs.Order">
	UPDATE
		orders
	SET
		discontinued = 0,
		discontinued_by = NULL,
		discontinued_date = NULL,
		discontinued_reason = NULL
	WHERE
		order_id = #orderId#
</update>

<update id="voidOrder" parameterClass="org.openmrs.Order">
	UPDATE
		orders
	SET
		voided = 1,
		voided_by = #voidedBy.userId#,
		void_date = NOW(),
		void_reason = #voidReason#
	WHERE
		order_id = #orderId#
</update>

<update id="unvoidOrder" parameterClass="org.openmrs.Order">
	UPDATE
		orders
	SET
		voided = 0,
		voided_by = NULL,
		void_date = NULL,
		void_reason = NULL
	WHERE
		order_id = #orderId#
</update>

</sqlMap>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
	"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="org.openmrs.User">

<!-- ************************************************************ -->
<!-- ** Creation                                               ** -->
<!-- ************************************************************ -->

<insert id="createUser" parameterClass="org.openmrs.User">
	INSERT INTO users
		(
		user_name,
		first_name,
		middle_name,
		last_name,
		creator,
		date_created
		)
	VALUES
		(
		#username#,
		#firstName#,
		#middleName#,
		#lastName#,
		#creator.userId#,
		NOW()
		);
	<selectKey keyProperty="userId">
		SELECT LAST_INSERT_ID() AS userId
	</selectKey>
</insert>

<!-- ************************************************************ -->
<!-- ** Read                                                   ** -->
<!-- ************************************************************ -->

<resultMap id="userResult" class="org.openmrs.User">
	<result property="userId" column="user_id" />
	<result property="username" column="user_name" />
	<result property="firstName" column="first_name" />
	<result property="middleName" column="middle_name" />
	<result property="lastName" column="last_name" />
	<result property="creator" column="creator" select="getUser" />
	<result property="dateCreated" column="date_created" />
	<result property="changedBy" column="changed_by" select="getUser" />
	<result property="voided" column="voided" nullValue="false" />
	<result property="dateVoided" column="date_voided" />
	<result property="voidedBy" column="voided_by" select="getUser" />
	<result property="roles" column="user_id" select="getRoleByUser" />
</resultMap>

<select id="getUser" parameterClass="int" resultMap="userResult">
	SELECT * FROM users WHERE user_id = #value#
</select>

<select id="getUserPassword" parameterClass="int" resultClass="string">
	SELECT password FROM users WHERE user_id = #userId#
</select>

<select id="getUserByUsername" parameterClass="string"
	resultMap="userResult">
	SELECT * FROM users WHERE user_name = #value#
</select>

<!-- ************************************************************ -->
<!-- ** Update                                                 ** -->
<!-- ************************************************************ -->

<update id="updateUser" parameterClass="org.openmrs.User">
	UPDATE
		users
	SET
		user_name = #username#,
		first_name = #firstName#,
		middle_name = #middleName#,
		last_name = #lastName#,
		changed_by = #changedBy.userId#,
		date_changed = NOW()
	WHERE
		user_id = #userId#
</update>

<update id="updateUserPassword" parameterClass="java.util.Map">
	UPDATE users SET password = #password# WHERE user_id = #userId#
</update>

<!-- ************************************************************ -->
<!-- ** Deletion                                               ** -->
<!-- ************************************************************ -->

<delete id="deleteUser" parameterClass="org.openmrs.User">
	DELETE FROM users WHERE user_id = #userId#
</delete>

<update id="voidUser" parameterClass="org.openmrs.User">
	UPDATE
		users
	SET
		voided = 1,
		voided_by = #voidedBy.userId#,
		date_voided = NOW()
	WHERE
		user_id = #userId#
</update>

<update id="unvoidUser" parameterClass="org.openmrs.User">
	UPDATE
		users
	SET
		changed_by = #changedBy.userId#,
		date_changed = NOW(),
		voided = 0,
		voided_by = NULL,
		date_voided = NULL
	WHERE
		user_id = #userId#
</update>

</sqlMap>
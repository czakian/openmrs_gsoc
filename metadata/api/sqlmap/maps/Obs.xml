<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
	"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="org.openmrs.Obs">

<!-- TODO -merge obs and complex_obs gracefully on each select so return -->
<!--       function knows if its an Obs or ComplexObs object             -->

<!-- ************************************************************ -->
<!-- ** Creation                                               ** -->
<!-- ************************************************************ -->
 
<insert id="createObs" parameterClass="org.openmrs.Obs">
	INSERT INTO obs
		(
		order_id,
		concept_id,
		patient_id,
		encounter_id,
		obs_datetime,
		location_id,
		obs_group_id,
		value_group_id,
		value_boolean,
		value_datetime,
		value_coded,
		value_numeric,
		value_modifier,
		value_text,
		comment,
		creator,
		date_created
		)
	VALUES
		(
		#order.orderId#,
		#concept.conceptId#,
		#patient.patientId#,
		#encounter.encounterId#,
		#obsDatetime#,
		#location.locationId#,
		#obsGroupId#,
		#valueGroupId#,
		#valueBoolean#,
		#valueDatetime#,
		#valueCoded.conceptId#,
		#valueNumeric#,
		#valueModifier#,
		#valueText#,
		#comment#,
		#creator.userId#,
		NOW()
		);
	<selectKey keyProperty="obsId">
		SELECT LAST_INSERT_ID() AS obsId
	</selectKey>
</insert>

<!-- ************************************************************ -->
<!-- ** Read                                                   ** -->
<!-- ************************************************************ -->

<resultMap id="obsResult" class="org.openmrs.Obs">
	<result property="obsId" column="obs_id" />
	<result property="concept" column="concept_id" select="getConcept" />
	<result property="patient" column="patient_id" select="getPatient" />
	<result property="encounter" column="encounter_id" select="getEncounter" />
	<result property="obsDatetime" column="obs_datetime" />
	<result property="location" column="location_id" select="getLocation" />
	<result property="obsGroupId" column="obs_group_id" />
	<result property="valueGroupId" column="value_group_id" />
	<result property="valueBoolean" column="value_boolean" />
	<result property="valueDatetime" column="value_datetime" />
	<result property="valueCoded" column="value_coded" select="getConcept" /> 
	<result property="valueNumeric" column="value_numeric" />
	<result property="valueModifier" column="value_modifier" />
	<result property="valueText" column="value_text" />
	<result property="comment" column="comment" />
	<result property="creator" column="creator" select="getUser" />
	<result property="dateCreated" column="date_created" /> 
	<result property="voided" column="voided" /> 
	<result property="voidedBy" column="voided_by" select="getUser" />
	<result property="dateVoided" column="date_voided" />
	<result property="voidReason" column="void_reason" /> 
</resultMap>

<select id="getObs" parameterClass="int" resultMap="obsResult">
	SELECT * FROM obs WHERE obs_id = #value#
</select>

<select id="getObsByEncounterId" parameterClass="int" resultMap="obsResult">
	SELECT * FROM obs WHERE encounter_id = #value#
</select>


<!-- ************************************************************ -->
<!-- ** Update                                                 ** -->
<!-- ************************************************************ -->

<update id="updateObs" parameterClass="org.openmrs.Obs">
	UPDATE
		obs
	SET
		order_id = #order.orderId#,
		concept_id = #concept.conceptId#,
		patient_id = #patient.patientId#,
		encounter_id = #encounter.encounterId#,
		obs_datetime = #obsDatetime#,
		location_id = #location.locationId#,
		obs_group_id = #obsGroupId#,
		value_group_id = #valueGroupId#,
		value_boolean = #valueBoolean#,
		value_datetime = #valueDatetime#,
		value_coded = #valueCoded.conceptId#,
		value_numeric = #valueNumeric#,
		value_modifier = #valueModifier#,
		value_text = #valueText#,
		comment = #comment#
	WHERE
		obs_id = #obsId#
</update>

<!-- ************************************************************ -->
<!-- ** Delete                                                 ** -->
<!-- ************************************************************ -->

<delete id="deleteObs" parameterClass="int">
	DELETE FROM obs WHERE obs_id = #value#
</delete>

<update id="voidObs" parameterClass="org.openmrs.Obs">
	UPDATE
		obs
	SET
		voided = 1,
		voided_by = #voidedBy.userId#,
		void_reason = #voidReason#,
		date_voided = NOW()
	WHERE
		obs_id = #obsId#
</update>

<update id="unvoidObs" parameterClass="org.openmrs.Obs">
	UPDATE
		obs
	SET
		<!-- changed_by = #changedBy.userId#, -->
		<!-- date_changed = NOW(), -->
		voided = 0,
		voided_by = NULL,
		void_reason = NULL,
		date_voided = NULL
	WHERE
		obs_id = #obsId#
</update>

</sqlMap>
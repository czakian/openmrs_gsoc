<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
	"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="org.openmrs.Form">

<!-- ************************************************************ -->
<!-- ** Creation                                               ** -->
<!-- ************************************************************ -->

<insert id="createForm" parameterClass="org.openmrs.Form">
	INSERT INTO form
		(
		name,
		version,
		description,
		schema_namespace,
		definition,
		creator,
		date_created,
		changed_by,
		date_changed
		)
	VALUES
		(
		#name#,
		#version#,
		#description#,
		#schemaNamespace#,
		#definition#,
		#creator.userId#,
		NOW(),
		#creator.userId#,
		NOW()
		);
	<selectKey keyProperty="formId">
		SELECT LAST_INSERT_ID() AS formId
	</selectKey>
</insert>

<!-- ************************************************************ -->
<!-- ** Read                                                   ** -->
<!-- ************************************************************ -->

<resultMap id="formResult" class="org.openmrs.Form">
	<result property="formId" column="form_id" />
	<result property="name" column="name" />
	<result property="version" column="version" />
	<result property="description" column="description" />
	<result property="schemaNamespace" column="schema_namespace" />
	<result property="definition" column="definition" />
	<result property="retired" column="retired" nullValue="false" />
	<result property="retiredBy" column="retired_by" select="getUser" />
	<result property="retiredReason" column="retired_reason" />
	<result property="dateRetired" column="date_retired" />
	<result property="creator" column="creator" select="getUser" />
	<result property="dateCreated" column="date_created" />
	<result property="changedBy" column="changed_by" select="getUser" />
	<result property="dateChanged" column="date_changed" />
	<result property="formFields" column="form_id" select="getFormFieldByFormId" />
</resultMap>

<select id="getForm" parameterClass="int" resultMap="formResult">
	SELECT * FROM form WHERE form_id = #value#
</select>

<!-- ************************************************************ -->
<!-- ** Update                                                 ** -->
<!-- ************************************************************ -->

<update id="updateForm" parameterClass="org.openmrs.Form">
	UPDATE
		form
	SET
		name = #name#,
		version = #version#,
		description = #description#,
		schema_namespace = #schemaNamespace#,
		definition = #definition#,
		changed_by = #changedBy.userId#,
		date_changed = NOW()
	WHERE
		form_id = #formId#
</update>

<!-- ************************************************************ -->
<!-- ** Deletion                                               ** -->
<!-- ************************************************************ -->

<delete id="deleteForm" parameterClass="org.openmrs.Form">
	DELETE FROM form WHERE form_id = #formId#
</delete>

<update id="retireForm" parameterClass="org.openmrs.Form">
	UPDATE
		form
	SET
		retired = 1,
		retired_by = #retiredBy.userId#,
		retired_reason = #retiredReason#,
		date_retired = NOW()
	WHERE
		form_id = #formId#
</update>

<update id="unretireForm" parameterClass="org.openmrs.Form">
	UPDATE
		form
	SET
		retired = 0,
		retired_by = NULL,
		retired_reason = NULL,
		date_retired = NULL
	WHERE
		form_id = #formId#
</update>


</sqlMap>
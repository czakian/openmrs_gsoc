<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
	"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="org.openmrs.Patient">

<!-- ************************************************************ -->
<!-- ** Creation                                               ** -->
<!-- ************************************************************ -->

<insert id="createPatient" parameterClass="org.openmrs.Patient">
	INSERT INTO patient
		(
		gender,
		race,
		birthdate,
		birthdate_estimated,
		birthplace,
		tribe,
		citizenship,
		mothers_name,
		civil_status,
		death_date,
		cause_of_death,
		health_district,
		health_center,
		creator,
		date_created
		)
	VALUES
		(
		#gender#,
		#race#,
		#birthdate#,
		#birthdateEstimated#,
		#birthplace#,
		#tribe.tribeId#,
		#citizenship#,
		#mothersName#,
		#civilStatus#,
		#deathDate#,
		#causeOfDeath#,
		#healthDistrict#,
		#healthCenter#,
		#creator.userId#,
		NOW()
		);
	<selectKey keyProperty="patientId">
		SELECT LAST_INSERT_ID() AS patientId
	</selectKey>
</insert>

<!-- ************************************************************ -->
<!-- ** Read                                                   ** -->
<!-- ************************************************************ -->

<resultMap id="patientResult" class="org.openmrs.Patient">
	<result property="patientId" column="patient_id" />
	<result property="identifiers" column="patient_id" select="getPatientIdentifierByPatientId" />
	<result property="names" column="patient_id" select="getPatientName" />
	<result property="gender" column="gender" />
	<result property="race" column="race" />
	<result property="birthdate" column="birthdate" />
	<result property="birthdateEstimated" column="birthdate_estimated" nullValue="false" />
	<result property="tribe" column="tribe" select="getTribe" />
	<result property="citizenship" column="citizenship" />
	<result property="mothersName" column="mothers_name" />
	<result property="civilStatus" column="civil_status" />
	<result property="deathDate" column="death_date" />
	<result property="causeOfDeath" column="cause_of_death" />
	<result property="healthDistrict" column="health_district" />
	<result property="healthCenter" column="health_center" />
	<result property="creator" column="creator" select="getUser" />
	<result property="dateCreated" column="date_created" />
	<result property="voided" column="voided" nullValue="false" />
	<result property="voidedBy" column="voided_by" select="getUser" />
	<result property="dateVoided" column="date_voided" />
	<result property="voidReason" column="void_reason" />
	<result property="addresses" column="patient_id" select="getPatientAddressByPatientId" />
	<result property="changedBy" column="changed_by" select="getUser" />
	<result property="dateChanged" column="date_changed" />
</resultMap>

<select id="getPatient" parameterClass="int" resultMap="patientResult">
	SELECT * FROM patient WHERE patient_id = #value#
</select>

<select id="getPatientByIdentifier" parameterClass="string" resultMap="patientResult">
	SELECT
		p.*
	FROM
		patient_identifier AS pi INNER JOIN patient AS p
		ON pi.patient_id = p.patient_id
	WHERE
		pi.identifier like #value#
</select>

<select id="getPatientByName"  parameterClass="string"
        resultMap="patientResult">
	SELECT
		p.*
	FROM
		patient_name AS pn INNER JOIN patient AS p
		ON pn.patient_id = p.patient_id
	WHERE
		pn.family_name like #value#
	ORDER BY
		pn.family_name, pn.given_name, pn.middle_name
</select>

<!-- ************************************************************ -->
<!-- ** Update                                                 ** -->
<!-- ************************************************************ -->

<update id="updatePatient" parameterClass="org.openmrs.Patient">
	UPDATE
		patient
	SET
		gender = #gender#,
		race = #race#,
		birthdate = #birthdate#,
		birthdate_estimated = #birthdateEstimated#,
		birthplace = #birthplace#,
		tribe = #tribe.tribeId#,
		citizenship = #citizenship#,
		mothers_name = #mothersName#,
		civil_status = #civilStatus#,
		death_date = #deathDate#,
		cause_of_death = #causeOfDeath#,
		health_district = #healthDistrict#,
		health_center = #healthCenter#,
		changed_by = #changedBy.userId#,
		date_changed = NOW()
	WHERE
		patient_id = #patientId#
</update>

<!-- ************************************************************ -->
<!-- ** Deletion                                               ** -->
<!-- ************************************************************ -->

<delete id="deletePatient" parameterClass="org.openmrs.Patient">
	DELETE FROM patient WHERE patient_id = #patientId#
</delete>
 
<update id="voidPatient" parameterClass="org.openmrs.Patient">
	UPDATE
		patient
	SET
		voided = 1,
		voided_by = #voidedBy.userId#,
		void_reason = #voidReason#,
		date_voided = NOW()
	WHERE
		patient_id = #patientId#
</update>

<update id="unvoidPatient" parameterClass="org.openmrs.Patient">
	UPDATE
		patient
	SET
		changed_by = #changedBy.userId#,
		date_changed = NOW(),
		voided = 0,
		voided_by = NULL,
		void_reason = NULL,
		date_voided = NULL
	WHERE
		patient_id = #patientId#
</update>

</sqlMap>
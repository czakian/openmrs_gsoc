<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
	"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="org.openmrs.PatientName">

<!-- ************************************************************ -->
<!-- ** Creation                                               ** -->
<!-- ************************************************************ -->

<insert id="createPatientName" parameterClass="org.openmrs.PatientName">
	INSERT INTO patient_name
		(
		preferred,
		patient_id,
		prefix,
		given_name,
		middle_name,
		family_name_prefix,
		family_name,
		family_name2,
		family_name_suffix,
		degree,
		creator,
		date_created
		)
	VALUES
		(
		#preferred#,
		#patient.patientId#,
		#prefix#,
		#givenName#,
		#middleName#,
		#familyNamePrefix#,
		#familyName#,
		#familyName2#,
		#familyNameSuffix#,
		#degree#,
		#creator.userId#,
		NOW()
		);
	<selectKey keyProperty="patientNameId">
		SELECT LAST_INSERT_ID() AS patientNameId
	</selectKey>
</insert>

<!-- ************************************************************ -->
<!-- ** Read                                                   ** -->
<!-- ************************************************************ -->

<resultMap id="patientNameResult" class="org.openmrs.PatientName">
	<result property="patientNameId" column="patient_name_id" />
	<result property="preferred" column="preferred" />
	<result property="patient" column="patient_id" select="getPatient" />
	<result property="prefix" column="prefix" />
	<result property="givenName" column="given_name" />
	<result property="middleName" column="middle_name" />
	<result property="familyNamePrefix" column="family_name_prefix" />
	<result property="familyName" column="family_name" />
	<result property="familyName2" column="family_name2" />
	<result property="familyNameSuffix" column="family_name_suffix" />
	<result property="degree" column="degree" />
	<result property="creator" column="creator" select="getUser" />
	<result property="dateCreated" column="date_created" />
	<result property="voided" column="voided" nullValue="false" />
	<result property="voidedBy" column="voided_by" select="getUser" />
	<result property="dateVoided" column="date_voided" />
	<result property="voidReason" column="void_reason" />
	<result property="changedBy" column="changed_by" select="getUser" />
	<result property="dateChanged" column="date_changed" />
</resultMap>

<select id="getPatientName" parameterClass="int" resultMap="patientNameResult">
	SELECT * FROM patient_name WHERE patient_name_id = #value#
</select>

<select id="getPatientNameByPatientId" parameterClass="int" resultMap="patientNameResult">
	SELECT * FROM patient_name WHERE patient_id = #value#
</select>

<!-- ************************************************************ -->
<!-- ** Update                                                 ** -->
<!-- ************************************************************ -->

<!-- TODO : do we want to track changes (change_by and date_changed) for names? -->
<update id="updatePatientName" parameterClass="org.openmrs.PatientName">
	UPDATE
		patient_name
	SET
		preferred = #preferred#,
		patient_id = #patient.patientId#,
		prefix = #prefix#,
		given_name = #givenName#,
		middle_name = #middleName#,
		family_name_prefix = #familyNamePrefix#,
		family_name = #familyName#,
		family_name2 = #familyName2#,
		family_name_suffix = #familyNameSuffix#,
		degree = #degree#
		changed_by = #changedBy.userId#,
		date_changed = NOW()
	WHERE
		patient_name_id = #patientNameId#
</update>

<!-- ************************************************************ -->
<!-- ** Deletion                                               ** -->
<!-- ************************************************************ -->

<delete id="deletePatientName" parameterClass="org.openmrs.PatientName">
	DELETE FROM patient_name WHERE patient_id = #patientNameId#
</delete>

<update id="voidPatientName" parameterClass="org.openmrs.PatientName">
	UPDATE
		patient_name
	SET
		voided = 1,
		voided_by = #voidedBy.userId#,
		date_voided = NOW(),
		void_reason = #voidReason#
	WHERE
		patient_name_id = #patientNameId#
</update>

<update id="unvoidPatientName" parameterClass="org.openmrs.PatientName">
	UPDATE
		patient_name
	SET
		voided = 0,
		voided_by = NULL,
		date_voided = NULL,
		void_reason = NULL,
		changed_by = #changedBy.userId#,
		date_changed = NOW()
	WHERE
		patient_name_id = #patientNameId#
</update>

</sqlMap>
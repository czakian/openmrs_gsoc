#parse($headerTemplate)

<script>
	var lastIndex = 0;
	var timeout	= null;
	var isDisplayingWarnings = false;	
	function showProgress() {
		
		// schedule the next update check first so we're sure it happens (in case an error occurs)
		timeout = setTimeout("showProgress()", 1000);
		
		jQuery.post("${setupPageUrl}", {page: "updateProgress.vm.ajaxRequest"} , function(data) {
			
			/*If we have any warnings from the database update, show them*/
			if(data != null && data.hasWarnings){
				jQuery("#hiddenInputs").show();				
				jQuery("#warnings").html(data.updateWarnings);
				jQuery("#updateWarnings").show();
				jQuery("#warningsAlert").show();
				jQuery("#updateLogFile").html(data.updateLogFile);					
				isDisplayingWarnings = true;
			}
			
			if(data == null || !data.updatesRequired)
			{
				if(isDisplayingWarnings == true)
					return;			
				
				window.location="index.htm";
				return;
			}
			
			if(data.hasErrors)
			{
				window.location="${setupPageUrl}";
				return;
			}
			
			jQuery("#lastActionMessage").html(data.message);
			
			/* put checkmarks next to all executed changesets except the last one (the last one is currently executing) */
			for (var x = lastIndex; x < data.changesetIds.length; x++) {
				var changesetId = data.changesetIds[x];
				jQuery("#" + changesetId + "loading").hide();
				jQuery("#" + changesetId + "checkmark").show();
			}
			
			/* save the last point in the list for next time */
			lastIndex = data.changesetIds.length - 1;
			
			/* show the loading image next to the last changeset because that one is currently executing */
			jQuery("#" + data.executingChangesetId + "checkmark").hide();
			jQuery("#" + data.executingChangesetId + "loading").show();
			
			jQuery("#logLinesDiv").show();
			var logLines = "";
			for(var i = 0; i < data.logLines.length; i++)
			{
				logLines += data.logLines[i] + "<br />";
			}
			jQuery("#logLines").html(logLines);
			
		}, "json");
		
	}
		
	#if( $updateJobStarted == true )
		jQuery(function() { showProgress(); });
	#end
</script>

<style>
	.changesetImage, #logLinesDiv {
		display: none;
	}
	#warningsAlert{
		display:none; border: solid 1px #ff0000; background-color: #FAEBED; padding:3px;
		text-align: center; width: 400px;
	}
</style>
	
<form method="post" autocomplete="off">
	<input type="hidden" name="page" value="reviewchanges.vm" /> 
			
	<div class="content">
		<table align="center" cellspacing="5" cellpadding="9">
			<tr>
				<td colspan="3" class="question">
					#if($isDatabaseUpdateInProgress)
						Another User is already running database updates!
					#else
						#if( $updateJobStarted != true )
							The following database updates are required:							
						#else
							The following database updates are being executed:
						#end
					#end
				</td>
			</tr>
			#if($isDatabaseUpdateInProgress != true)
			<tr>
				<td>
					<table>
						<tr>
							<th></th>
							<th>Description of Update</th>
							<th>Actions</th>
							<th>Author</th>
						</tr>						
						#foreach ($change in $changes)
							<tr>
								<td>
									<img id="${change.id}checkmark" class="changesetImage" src="images/checkmark.png"/>
									<img id="${change.id}loading" class="changesetImage" src="images/loading.gif"/>
								</td>
								<td>${change.comments}</td>
								<td>${change.description}</td>
								<td>${change.author}</td>
							</tr>
						#end						
					</table>
				</td>
			</tr>
			#end
			#if( $updateJobStarted != true && $isDatabaseUpdateInProgress != true )
				<tr>
					<td colspan="3"><input type="submit" value="Run Updates" class="button"/></td>
				</tr>
			#end			
		</table>	
						
		<div id="updateWarnings" style="display:none; padding-top: 20px">
			<div>
			  <b>
				The following warning were generated by the database updater, 
			 	Please fix any issues related to the warnings and save this page for future reference.			 	
			  </b>			  
			</div>
			<br />
			<b>The warnings and messages have been saved to the file below:</b>
			<div id="updateLogFile" style="padding-left:20px"></div>
					
			<div id="warnings"></div>
		</div>
		
		<br />
		
		<div id="hiddenInputs" style="display:none">
					
			<br />
			
			<div id="warningsAlert">
				Record this issue and fix it if possible.
			</div>
			
			<br />
			
			<div>
				<input type="button" value="Continue" class="button" onclick="javascript:window.location='index.htm'" />
			</div>
		</div>
		
		<br />
		
     	<div id="lastActionMessage"></div>
       	
       	<br />
       	
       	<div id="logLinesDiv">
			Server log file output:
			<div id="logLines"></div>
		</div>		
	</div>	
</form>
#parse($footerTemplate)
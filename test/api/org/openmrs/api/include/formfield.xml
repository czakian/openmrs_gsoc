<?xml version='1.0' encoding='UTF-8'?>
<dataset>
  <concept_name_tag concept_name_tag_id="1" tag="default" description="name to use when nothing else is available" creator="1" date_created="2007-05-01 00:00:00.0" voided="false"/>
  <concept_name_tag concept_name_tag_id="2" tag="short" description="preferred short name for a concept" creator="1" date_created="2007-05-01 00:00:00.0" voided="false"/>
  <concept_name_tag concept_name_tag_id="3" tag="synonym" description="a different word with similar meaning" creator="1" date_created="2007-05-01 00:00:00.0" voided="false"/>
  <concept_name_tag concept_name_tag_id="4" tag="preferred" description="preferred name in a language" creator="1" date_created="2007-05-01 00:00:00.0" voided="false"/>
  <concept_name_tag concept_name_tag_id="5" tag="preferred_KE" description="preferred name in Kenya" creator="1" date_created="2007-06-20 00:00:00.0" voided="false"/>
  <concept_name_tag concept_name_tag_id="6" tag="preferred_LS" description="preferred name in Lesotho" creator="1" date_created="2007-06-20 00:00:00.0" voided="false"/>
  <concept_name_tag concept_name_tag_id="7" tag="preferred_MW" description="preferred name in Malawi" creator="1" date_created="2007-06-20 00:00:00.0" voided="false"/>
  <concept_name_tag concept_name_tag_id="8" tag="preferred_RW" description="preferred name in Rwanda" creator="1" date_created="2007-06-20 00:00:00.0" voided="false"/>
  <concept_name_tag concept_name_tag_id="9" tag="preferred_SA" description="preferred name in South Africa" creator="1" date_created="2007-06-20 00:00:00.0" voided="false"/>
  <concept_name_tag concept_name_tag_id="10" tag="preferred_TZ" description="preferred name in Tanzania" creator="1" date_created="2007-06-20 00:00:00.0" voided="false"/>
  <concept_name_tag concept_name_tag_id="11" tag="preferred_UG" description="preferred name in Uganda" creator="1" date_created="2007-06-20 00:00:00.0" voided="false"/>
  <concept_name_tag concept_name_tag_id="12" tag="preferred_UK" description="preferred name in the United Kingdom" creator="1" date_created="2007-06-20 00:00:00.0" voided="false"/>
  <concept_name_tag concept_name_tag_id="13" tag="preferred_US" description="preferred name in the United States" creator="1" date_created="2007-06-20 00:00:00.0" voided="false"/>
  <concept_name_tag concept_name_tag_id="14" tag="preferred_ZM" description="preferred name in Zambia" creator="1" date_created="2007-06-20 00:00:00.0" voided="false"/>
  <concept_name_tag concept_name_tag_id="15" tag="preferred_ZW" description="preferred name in Zimbabwe" creator="1" date_created="2007-06-20 00:00:00.0" voided="false"/>
  <field field_id="1" name="SELF PAY" description="Patient pays for their own evaluation and related treatment.  Used as an answer for &quot;pay category&quot;." field_type="1" concept_id="5269" table_name="" default_value="" select_multiple="false" creator="1" date_created="2006-07-18 11:03:31.0" retired="false"/>
  <field field_id="2" name="PATIENT" description="Patient section of form" field_type="5" table_name="" default_value="" select_multiple="false" creator="1" date_created="2006-07-18 11:04:36.0" retired="false"/>
  <field field_id="3" name="ENCOUNTER" description="Encounter section of form" field_type="5" table_name="" default_value="" select_multiple="false" creator="1" date_created="2006-07-18 11:06:52.0" retired="false"/>
  <form form_id="1" name="Basic Form" version="0.1" build="0" published="0" description="This form contains only the common/core elements needed for most forms" xslt="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;  &lt;!-- OpenMRS FormEntry Form HL7 Translation  This XSLT is used to translate OpenMRS forms from XML into HL7 2.5 format  @author Burke Mamlin, MD @author Ben Wolfe @version 1.9.4  1.9.4 - add support for message uid (as HL7 control id) and transform of patient.health_center to Discharge to Location (PV1-37) 1.9.3 - fixed rounding error on timestamp (tenths of seconds getting rounded up, causing &quot;60&quot; seconds in some cases)  1.9.2 - first generally useful version --&gt;  &lt;xsl:stylesheet version=&quot;2.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot; xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:fn=&quot;http://www.w3.org/2005/xpath-functions&quot; xmlns:xdt=&quot;http://www.w3.org/2005/xpath-datatypes&quot;&gt;  &lt;xsl:output method=&quot;text&quot; version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; indent=&quot;no&quot;/&gt;  &lt;xsl:variable name=&quot;SENDING-APPLICATION&quot;&gt;FORMENTRY&lt;/xsl:variable&gt; &lt;xsl:variable name=&quot;SENDING-FACILITY&quot;&gt;AMRS.ELD&lt;/xsl:variable&gt; &lt;xsl:variable name=&quot;RECEIVING-APPLICATION&quot;&gt;HL7LISTENER&lt;/xsl:variable&gt; &lt;xsl:variable name=&quot;RECEIVING-FACILITY&quot;&gt;AMRS.ELD&lt;/xsl:variable&gt; &lt;xsl:variable name=&quot;PATIENT-AUTHORITY&quot;&gt;&lt;/xsl:variable&gt; &lt;!-- leave blank for internal id, max 20 characters --&gt;                                                        &lt;!-- for now, must match patient_identifier_type.name --&gt; &lt;xsl:variable name=&quot;FORM-AUTHORITY&quot;&gt;AMRS.ELD.FORMID&lt;/xsl:variable&gt; &lt;!-- max 20 characters --&gt;  &lt;xsl:template match=&quot;/&quot;&gt;  &lt;xsl:apply-templates /&gt; &lt;/xsl:template&gt;  &lt;!-- Form template --&gt; &lt;xsl:template match=&quot;form&quot;&gt;  &lt;!-- MSH Header --&gt;  &lt;xsl:text&gt;MSH|^~\&amp;amp;&lt;/xsl:text&gt;   &lt;!-- Message header, field separator, and encoding characters --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-3 Sending application --&gt;  &lt;xsl:value-of select=&quot;$SENDING-APPLICATION&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-4 Sending facility --&gt;  &lt;xsl:value-of select=&quot;$SENDING-FACILITY&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-5 Receiving application --&gt;  &lt;xsl:value-of select=&quot;$RECEIVING-APPLICATION&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-6 Receiving facility --&gt;  &lt;xsl:value-of select=&quot;$RECEIVING-FACILITY&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-7 Date/time message sent --&gt;  &lt;xsl:call-template name=&quot;hl7Timestamp&quot;&gt;   &lt;xsl:with-param name=&quot;date&quot; select=&quot;current-dateTime()&quot; /&gt;  &lt;/xsl:call-template&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-8 Security --&gt;  &lt;xsl:text&gt;|ORU^R01&lt;/xsl:text&gt;       &lt;!-- MSH-9 Message type ^ Event type (observation report unsolicited) --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-10 Message control ID --&gt;  &lt;xsl:choose&gt;   &lt;xsl:when test=&quot;header/uid&quot;&gt;    &lt;xsl:value-of select=&quot;header/uid&quot; /&gt;   &lt;/xsl:when&gt;   &lt;xsl:otherwise&gt;    &lt;xsl:value-of select=&quot;patient/patient.patient_id&quot; /&gt;    &lt;xsl:call-template name=&quot;hl7Timestamp&quot;&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;current-dateTime()&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:otherwise&gt;  &lt;/xsl:choose&gt;  &lt;xsl:text&gt;|P&lt;/xsl:text&gt;             &lt;!-- MSH-11 Processing ID --&gt;  &lt;xsl:text&gt;|2.5&lt;/xsl:text&gt;           &lt;!-- MSH-12 HL7 version --&gt;  &lt;xsl:text&gt;|1&lt;/xsl:text&gt;             &lt;!-- MSH-13 Message sequence number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-14 Continuation Pointer --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-15 Accept Acknowledgement Type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-16 Application Acknowledgement Type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-17 Country Code --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-18 Character Set --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-19 Principal Language of Message --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-20 Alternate Character Set Handling Scheme --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-21 Message Profile Identifier --&gt;  &lt;xsl:value-of select=&quot;@id&quot; /&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;  &lt;xsl:value-of select=&quot;$FORM-AUTHORITY&quot; /&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;   &lt;!-- PID header --&gt;  &lt;xsl:text&gt;PID&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-1 Set ID --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-2 (deprecated) Patient ID --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-3 Patient Identifier List --&gt;  &lt;xsl:call-template name=&quot;patient_id&quot;&gt;   &lt;xsl:with-param name=&quot;pid&quot; select=&quot;patient/patient.patient_id&quot; /&gt;   &lt;xsl:with-param name=&quot;auth&quot; select=&quot;$PATIENT-AUTHORITY&quot; /&gt;   &lt;xsl:with-param name=&quot;type&quot; select=&quot;L&quot; /&gt;  &lt;/xsl:call-template&gt;  &lt;xsl:if test=&quot;patient/patient.previous_mrn and string-length(patient/patient.previous_mrn) &gt; 0&quot;&gt;   &lt;xsl:text&gt;~&lt;/xsl:text&gt;   &lt;xsl:call-template name=&quot;patient_id&quot;&gt;    &lt;xsl:with-param name=&quot;pid&quot; select=&quot;patient/patient.previous_mrn&quot; /&gt;    &lt;xsl:with-param name=&quot;auth&quot; select=&quot;$PATIENT-AUTHORITY&quot; /&gt;    &lt;xsl:with-param name=&quot;type&quot; select=&quot;PRIOR&quot; /&gt;   &lt;/xsl:call-template&gt;  &lt;/xsl:if&gt;  &lt;!-- Additional patient identifiers --&gt;  &lt;!-- This example is for an MTCT-PLUS identifier used in the AMPATH project in Kenya (skipped if not present) --&gt;  &lt;xsl:if test=&quot;patient/patient.mtctplus_id and string-length(patient/patient.mtctplus_id) &gt; 0&quot;&gt;   &lt;xsl:text&gt;~&lt;/xsl:text&gt;   &lt;xsl:call-template name=&quot;patient_id&quot;&gt;    &lt;xsl:with-param name=&quot;pid&quot; select=&quot;patient/patient.mtctplus_id&quot; /&gt;    &lt;xsl:with-param name=&quot;auth&quot; select=&quot;$PATIENT-AUTHORITY&quot; /&gt;    &lt;xsl:with-param name=&quot;type&quot; select=&quot;MTCTPLUS&quot; /&gt;   &lt;/xsl:call-template&gt;  &lt;/xsl:if&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-4 (deprecated) Alternate patient ID --&gt;  &lt;!-- PID-5 Patient name --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- Family name --&gt;  &lt;xsl:value-of select=&quot;patient/patient.family_name&quot; /&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Given name --&gt;  &lt;xsl:value-of select=&quot;patient/patient.given_name&quot; /&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Middle name --&gt;  &lt;xsl:value-of select=&quot;patient/patient.middle_name&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-6 Mother&apos;s maiden name --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-7 Date/Time of Birth --&gt;  &lt;xsl:value-of select=&quot;patient/patient.date_of_birth&quot; /&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;    &lt;!-- PV1 header --&gt;  &lt;xsl:text&gt;PV1&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-1 Sub ID --&gt;  &lt;xsl:text&gt;|O&lt;/xsl:text&gt;             &lt;!-- PV1-2 Patient class (O = outpatient) --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-3 Patient location --&gt;  &lt;xsl:value-of select=&quot;encounter/encounter.location_id&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-4 Admission type (2 = return) --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-5 Pre-Admin Number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-6 Prior Patient Location --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-7 Attending Doctor --&gt;  &lt;xsl:value-of select=&quot;encounter/encounter.provider_id&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-8 Referring Doctor --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-9 Consulting Doctor --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-10 Hospital Service --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-11 Temporary Location --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-12 Preadmin Test Indicator --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-13 Re-adminssion Indicator --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-14 Admit Source --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-15 Ambulatory Status --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-16 VIP Indicator --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-17 Admitting Doctor --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-18 Patient Type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-19 Visit Number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-20 Financial Class --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-21 Charge Price Indicator --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-22 Courtesy Code --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-23 Credit Rating --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-24 Contract Code --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-25 Contract Effective Date --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-26 Contract Amount --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-27 Contract Period --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-28 Interest Code --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-29 Transfer to Bad Debt Code --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-30 Transfer to Bad Debt Date --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-31 Bad Debt Agency Code --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-31 Bad Debt Transfer Amount --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-33 Bad Debt Recovery Amount --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-34 Delete Account Indicator --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-35 Delete Account Date --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-36 Discharge Disposition --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-37 Discharge To Location --&gt;  &lt;xsl:if test=&quot;patient/patient.health_center&quot;&gt;   &lt;xsl:value-of select=&quot;replace(patient/patient.health_center,&apos;\^&apos;,&apos;&amp;amp;&apos;)&quot; /&gt;  &lt;/xsl:if&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-38 Diet Type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-39 Servicing Facility --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-40 Bed Status --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-41 Account Status --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-42 Pending Location --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-43 Prior Temporary Location --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-44 Admit Date/Time --&gt;  &lt;xsl:call-template name=&quot;hl7Date&quot;&gt;   &lt;xsl:with-param name=&quot;date&quot; select=&quot;encounter/encounter.encounter_datetime&quot; /&gt;  &lt;/xsl:call-template&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-45 Discharge Date/Time --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-46 Current Patient Balance --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-47 Total Charges --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-48 Total Adjustments --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-49 Total Payments --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-50 Alternate Visit ID --&gt;  &lt;xsl:text&gt;|V&lt;/xsl:text&gt;             &lt;!-- PV1-51 Visit Indicator --&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;   &lt;!-- We use encounter date as the timestamp for each observation --&gt;  &lt;xsl:variable name=&quot;encounterTimestamp&quot;&gt;   &lt;xsl:call-template name=&quot;hl7Date&quot;&gt;    &lt;xsl:with-param name=&quot;date&quot; select=&quot;encounter/encounter.encounter_datetime&quot; /&gt;   &lt;/xsl:call-template&gt;  &lt;/xsl:variable&gt;    &lt;!-- ORC Common Order Segment --&gt;  &lt;xsl:text&gt;ORC&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;  &lt;xsl:text&gt;|RE&lt;/xsl:text&gt;            &lt;!-- ORC-1 Order Control (RE = obs to follow) --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-2 Placer Order Number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-3 Filler Order Number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-4 Placer Group Number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-5 Order Status --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-6 Response Flag --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-7 Quantity/Timing --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-8 Parent --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-9 Date/Time of Transaction --&gt;  &lt;xsl:call-template name=&quot;hl7Timestamp&quot;&gt;   &lt;xsl:with-param name=&quot;date&quot; select=&quot;xs:dateTime(header/date_entered)&quot; /&gt;  &lt;/xsl:call-template&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-10 Entered By --&gt;  &lt;xsl:value-of select=&quot;header/enterer&quot; /&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;   &lt;!-- Observation(s) --&gt;  &lt;xsl:variable name=&quot;obsList&quot; select=&quot;obs/*[(@openmrs_concept and value and value/text() != &apos;&apos;) or *[@openmrs_concept and text()=&apos;true&apos;]]&quot; /&gt;  &lt;xsl:variable name=&quot;obsListCount&quot; select=&quot;count($obsList)&quot; as=&quot;xs:integer&quot; /&gt;  &lt;!-- Observation OBR --&gt;  &lt;xsl:text&gt;OBR&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-1 Set ID --&gt;  &lt;xsl:text&gt;1&lt;/xsl:text&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-2 Placer order number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-3 Filler order number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-4 OBR concept --&gt;  &lt;xsl:value-of select=&quot;obs/@openmrs_concept&quot; /&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;   &lt;!-- observation OBXs --&gt;  &lt;xsl:for-each select=&quot;$obsList&quot;&gt;   &lt;xsl:choose&gt;    &lt;xsl:when test=&quot;value&quot;&gt;     &lt;xsl:call-template name=&quot;obsObx&quot;&gt;      &lt;xsl:with-param name=&quot;setId&quot; select=&quot;position()&quot; /&gt;      &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;@openmrs_datatype&quot; /&gt;      &lt;xsl:with-param name=&quot;units&quot; select=&quot;@openmrs_units&quot; /&gt;      &lt;xsl:with-param name=&quot;concept&quot; select=&quot;@openmrs_concept&quot; /&gt;      &lt;xsl:with-param name=&quot;date&quot; select=&quot;date/text()&quot; /&gt;      &lt;xsl:with-param name=&quot;time&quot; select=&quot;time/text()&quot; /&gt;      &lt;xsl:with-param name=&quot;value&quot; select=&quot;value&quot; /&gt;      &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;     &lt;/xsl:call-template&gt;    &lt;/xsl:when&gt;    &lt;xsl:otherwise&gt;     &lt;xsl:variable name=&quot;setId&quot; select=&quot;position()&quot; /&gt;     &lt;xsl:for-each select=&quot;*[@openmrs_concept and text() = &apos;true&apos;]&quot;&gt;      &lt;xsl:call-template name=&quot;obsObx&quot;&gt;       &lt;xsl:with-param name=&quot;setId&quot; select=&quot;$setId&quot; /&gt;       &lt;xsl:with-param name=&quot;subId&quot; select=&quot;concat($setId,position())&quot; /&gt;       &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;../@openmrs_datatype&quot; /&gt;       &lt;xsl:with-param name=&quot;units&quot; select=&quot;../@openmrs_units&quot; /&gt;       &lt;xsl:with-param name=&quot;concept&quot; select=&quot;../@openmrs_concept&quot; /&gt;       &lt;xsl:with-param name=&quot;date&quot; select=&quot;../date/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;time&quot; select=&quot;../time/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;value&quot; select=&quot;@openmrs_concept&quot; /&gt;       &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;      &lt;/xsl:call-template&gt;     &lt;/xsl:for-each&gt;    &lt;/xsl:otherwise&gt;   &lt;/xsl:choose&gt;  &lt;/xsl:for-each&gt;    &lt;!-- Grouped observation(s) --&gt;  &lt;xsl:variable name=&quot;obsGroupList&quot; select=&quot;obs/*[@openmrs_concept and not(date) and *[(@openmrs_concept and value and value/text() != &apos;&apos;) or *[@openmrs_concept and text()=&apos;true&apos;]]]&quot; /&gt;  &lt;xsl:variable name=&quot;obsGroupListCount&quot; select=&quot;count($obsGroupList)&quot; as=&quot;xs:integer&quot; /&gt;  &lt;xsl:for-each select=&quot;$obsGroupList&quot;&gt;   &lt;!-- Observation OBR --&gt;   &lt;xsl:text&gt;OBR&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-1 Set ID --&gt;   &lt;xsl:value-of select=&quot;$obsListCount + position()&quot; /&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-2 Placer order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-3 Filler order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-4 OBR concept --&gt;   &lt;xsl:value-of select=&quot;@openmrs_concept&quot; /&gt;   &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;      &lt;!-- Generate OBXs --&gt;   &lt;xsl:for-each select=&quot;*[(@openmrs_concept and value and value/text() != &apos;&apos;) or *[@openmrs_concept and text()=&apos;true&apos;]]&quot;&gt;    &lt;xsl:choose&gt;     &lt;xsl:when test=&quot;value&quot;&gt;      &lt;xsl:call-template name=&quot;obsObx&quot;&gt;       &lt;xsl:with-param name=&quot;setId&quot; select=&quot;position()&quot; /&gt;       &lt;xsl:with-param name=&quot;subId&quot; select=&quot;1&quot; /&gt;       &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;@openmrs_datatype&quot; /&gt;       &lt;xsl:with-param name=&quot;units&quot; select=&quot;@openmrs_units&quot; /&gt;       &lt;xsl:with-param name=&quot;concept&quot; select=&quot;@openmrs_concept&quot; /&gt;       &lt;xsl:with-param name=&quot;date&quot; select=&quot;date/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;time&quot; select=&quot;time/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;value&quot; select=&quot;value&quot; /&gt;       &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;      &lt;/xsl:call-template&gt;     &lt;/xsl:when&gt;     &lt;xsl:otherwise&gt;      &lt;xsl:variable name=&quot;setId&quot; select=&quot;position()&quot; /&gt;      &lt;xsl:for-each select=&quot;*[@openmrs_concept and text() = &apos;true&apos;]&quot;&gt;       &lt;xsl:call-template name=&quot;obsObx&quot;&gt;        &lt;xsl:with-param name=&quot;setId&quot; select=&quot;$setId&quot; /&gt;        &lt;xsl:with-param name=&quot;subId&quot; select=&quot;concat(&apos;1.&apos;,position())&quot; /&gt;        &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;../@openmrs_datatype&quot; /&gt;        &lt;xsl:with-param name=&quot;units&quot; select=&quot;../@openmrs_units&quot; /&gt;        &lt;xsl:with-param name=&quot;concept&quot; select=&quot;../@openmrs_concept&quot; /&gt;        &lt;xsl:with-param name=&quot;date&quot; select=&quot;../date/text()&quot; /&gt;        &lt;xsl:with-param name=&quot;time&quot; select=&quot;../time/text()&quot; /&gt;        &lt;xsl:with-param name=&quot;value&quot; select=&quot;@openmrs_concept&quot; /&gt;        &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;       &lt;/xsl:call-template&gt;      &lt;/xsl:for-each&gt;     &lt;/xsl:otherwise&gt;    &lt;/xsl:choose&gt;   &lt;/xsl:for-each&gt;  &lt;/xsl:for-each&gt;   &lt;!-- Problem list(s) --&gt;  &lt;xsl:variable name=&quot;problemList&quot; select=&quot;problem_list/*[value[text() != &apos;&apos;]]&quot; /&gt;  &lt;xsl:variable name=&quot;problemListCount&quot; select=&quot;count($problemList)&quot; as=&quot;xs:integer&quot; /&gt;  &lt;xsl:if test=&quot;$problemList&quot;&gt;   &lt;!-- Problem list OBR --&gt;   &lt;xsl:text&gt;OBR&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-1 Set ID --&gt;   &lt;xsl:value-of select=&quot;$obsListCount + $obsGroupListCount + 1&quot; /&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-2 Placer order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-3 Filler order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-4 OBR concept --&gt;   &lt;xsl:value-of select=&quot;problem_list/@openmrs_concept&quot; /&gt;   &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;    &lt;!-- Problem list OBXs --&gt;   &lt;xsl:for-each select=&quot;$problemList&quot;&gt;    &lt;xsl:call-template name=&quot;obsObx&quot;&gt;     &lt;xsl:with-param name=&quot;setId&quot; select=&quot;position()&quot; /&gt;     &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;&apos;CWE&apos;&quot; /&gt;     &lt;xsl:with-param name=&quot;concept&quot; select=&quot;@openmrs_concept&quot; /&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;date/text()&quot; /&gt;     &lt;xsl:with-param name=&quot;time&quot; select=&quot;time/text()&quot; /&gt;     &lt;xsl:with-param name=&quot;value&quot; select=&quot;value&quot; /&gt;     &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;    &lt;/xsl:call-template&gt;     &lt;/xsl:for-each&gt;  &lt;/xsl:if&gt;    &lt;!-- Orders --&gt;  &lt;xsl:variable name=&quot;orderList&quot; select=&quot;orders/*[*[@openmrs_concept and ((value and value/text() != &apos;&apos;) or *[@openmrs_concept and text() = &apos;true&apos;])]]&quot; /&gt;  &lt;xsl:variable name=&quot;orderListCount&quot; select=&quot;count($orderList)&quot; as=&quot;xs:integer&quot; /&gt;  &lt;xsl:for-each select=&quot;$orderList&quot;&gt;   &lt;!-- Order section OBR --&gt;   &lt;xsl:text&gt;OBR&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-1 Set ID --&gt;   &lt;xsl:value-of select=&quot;$obsListCount + $obsGroupListCount + $problemListCount + 1&quot; /&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-2 Placer order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-3 Filler order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-4 OBR concept --&gt;   &lt;xsl:value-of select=&quot;@openmrs_concept&quot; /&gt;   &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;     &lt;!-- Order OBXs --&gt;   &lt;xsl:for-each select=&quot;*[@openmrs_concept and ((value and value/text() != &apos;&apos;) or *[@openmrs_concept and text() = &apos;true&apos;])]&quot;&gt;    &lt;xsl:choose&gt;     &lt;xsl:when test=&quot;value&quot;&gt;      &lt;xsl:call-template name=&quot;obsObx&quot;&gt;       &lt;xsl:with-param name=&quot;setId&quot; select=&quot;position()&quot; /&gt;       &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;@openmrs_datatype&quot; /&gt;       &lt;xsl:with-param name=&quot;units&quot; select=&quot;@openmrs_units&quot; /&gt;       &lt;xsl:with-param name=&quot;concept&quot; select=&quot;@openmrs_concept&quot; /&gt;       &lt;xsl:with-param name=&quot;date&quot; select=&quot;date/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;time&quot; select=&quot;time/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;value&quot; select=&quot;value&quot; /&gt;       &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;      &lt;/xsl:call-template&gt;     &lt;/xsl:when&gt;     &lt;xsl:otherwise&gt;      &lt;xsl:variable name=&quot;setId&quot; select=&quot;position()&quot; /&gt;      &lt;xsl:for-each select=&quot;*[@openmrs_concept and text() = &apos;true&apos;]&quot;&gt;       &lt;xsl:call-template name=&quot;obsObx&quot;&gt;        &lt;xsl:with-param name=&quot;setId&quot; select=&quot;$setId&quot; /&gt;        &lt;xsl:with-param name=&quot;subId&quot; select=&quot;position()&quot; /&gt;        &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;../@openmrs_datatype&quot; /&gt;        &lt;xsl:with-param name=&quot;units&quot; select=&quot;../@openmrs_units&quot; /&gt;        &lt;xsl:with-param name=&quot;concept&quot; select=&quot;../@openmrs_concept&quot; /&gt;        &lt;xsl:with-param name=&quot;date&quot; select=&quot;../date/text()&quot; /&gt;        &lt;xsl:with-param name=&quot;time&quot; select=&quot;../time/text()&quot; /&gt;        &lt;xsl:with-param name=&quot;value&quot; select=&quot;@openmrs_concept&quot; /&gt;        &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;       &lt;/xsl:call-template&gt;      &lt;/xsl:for-each&gt;     &lt;/xsl:otherwise&gt;    &lt;/xsl:choose&gt;   &lt;/xsl:for-each&gt;   &lt;/xsl:for-each&gt;   &lt;/xsl:template&gt;  &lt;!-- Patient Identifier (CX) generator --&gt; &lt;xsl:template name=&quot;patient_id&quot;&gt;  &lt;xsl:param name=&quot;pid&quot; /&gt;  &lt;xsl:param name=&quot;auth&quot; /&gt;  &lt;xsl:param name=&quot;type&quot; /&gt;  &lt;xsl:value-of select=&quot;$pid&quot; /&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Check digit --&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Check Digit Scheme --&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Assigning Authority --&gt;  &lt;xsl:value-of select=&quot;$auth&quot; /&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Identifier Type --&gt;  &lt;xsl:value-of select=&quot;$type&quot; /&gt; &lt;/xsl:template&gt;  &lt;!-- OBX Generator --&gt; &lt;xsl:template name=&quot;obsObx&quot;&gt;  &lt;xsl:param name=&quot;setId&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;subId&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;datatype&quot; required=&quot;yes&quot; /&gt;  &lt;xsl:param name=&quot;concept&quot; required=&quot;yes&quot; /&gt;  &lt;xsl:param name=&quot;date&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;time&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;value&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;units&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;encounterTimestamp&quot; required=&quot;yes&quot; /&gt;  &lt;xsl:text&gt;OBX&lt;/xsl:text&gt;                     &lt;!-- Message type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Set ID --&gt;  &lt;xsl:value-of select=&quot;$setId&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Observation datatype --&gt;  &lt;xsl:choose&gt;   &lt;xsl:when test=&quot;$datatype = &apos;BIT&apos;&quot;&gt;    &lt;xsl:text&gt;NM&lt;/xsl:text&gt;   &lt;/xsl:when&gt;   &lt;xsl:otherwise&gt;    &lt;xsl:value-of select=&quot;$datatype&quot; /&gt;   &lt;/xsl:otherwise&gt;  &lt;/xsl:choose&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Concept (what was observed --&gt;  &lt;xsl:value-of select=&quot;$concept&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Sub-ID --&gt;  &lt;xsl:value-of select=&quot;$subId&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Value --&gt;  &lt;xsl:choose&gt;   &lt;xsl:when test=&quot;$datatype = &apos;TS&apos;&quot;&gt;    &lt;xsl:call-template name=&quot;hl7Timestamp&quot;&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;$value&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:when&gt;   &lt;xsl:when test=&quot;$datatype = &apos;DT&apos;&quot;&gt;    &lt;xsl:call-template name=&quot;hl7Date&quot;&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;$value&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:when&gt;   &lt;xsl:when test=&quot;$datatype = &apos;TM&apos;&quot;&gt;    &lt;xsl:call-template name=&quot;hl7Time&quot;&gt;     &lt;xsl:with-param name=&quot;time&quot; select=&quot;$value&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:when&gt;   &lt;xsl:when test=&quot;$datatype = &apos;BIT&apos;&quot;&gt;    &lt;xsl:choose&gt;     &lt;xsl:when test=&quot;$value = &apos;0&apos; or upper-case($value) = &apos;FALSE&apos;&quot;&gt;0&lt;/xsl:when&gt;     &lt;xsl:otherwise&gt;1&lt;/xsl:otherwise&gt;    &lt;/xsl:choose&gt;   &lt;/xsl:when&gt;   &lt;xsl:otherwise&gt;    &lt;xsl:value-of select=&quot;$value&quot; /&gt;   &lt;/xsl:otherwise&gt;  &lt;/xsl:choose&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Units --&gt;  &lt;xsl:value-of select=&quot;$units&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Reference range --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Abnormal flags --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Probability --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Nature of abnormal test --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Observation result status --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Effective date --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- User defined access checks --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Date time of observation --&gt;  &lt;xsl:choose&gt;   &lt;xsl:when test=&quot;$date and $time&quot;&gt;    &lt;xsl:call-template name=&quot;hl7Timestamp&quot;&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;dateTime($date,$time)&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:when&gt;   &lt;xsl:when test=&quot;$date&quot;&gt;    &lt;xsl:call-template name=&quot;hl7Date&quot;&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;$date&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:when&gt;   &lt;xsl:otherwise&gt;    &lt;xsl:value-of select=&quot;$encounterTimestamp&quot; /&gt;   &lt;/xsl:otherwise&gt;  &lt;/xsl:choose&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt; &lt;/xsl:template&gt;  &lt;!-- Generate HL7-formatted timestamp --&gt; &lt;xsl:template name=&quot;hl7Timestamp&quot;&gt;  &lt;xsl:param name=&quot;date&quot; /&gt;  &lt;xsl:if test=&quot;string($date) != &apos;&apos;&quot;&gt;   &lt;xsl:value-of select=&quot;concat(year-from-dateTime($date),format-number(month-from-dateTime($date),&apos;00&apos;),format-number(day-from-dateTime($date),&apos;00&apos;),format-number(hours-from-dateTime($date),&apos;00&apos;),format-number(minutes-from-dateTime($date),&apos;00&apos;),format-number(floor(seconds-from-dateTime($date)),&apos;00&apos;))&quot; /&gt;  &lt;/xsl:if&gt; &lt;/xsl:template&gt;  &lt;!-- Generate HL7-formatted date --&gt; &lt;xsl:template name=&quot;hl7Date&quot;&gt;  &lt;xsl:param name=&quot;date&quot; /&gt;  &lt;xsl:if test=&quot;string($date) != &apos;&apos;&quot;&gt;   &lt;xsl:choose&gt;    &lt;xsl:when test=&quot;contains(string($date),&apos;T&apos;)&quot;&gt;     &lt;xsl:call-template name=&quot;hl7Date&quot;&gt;      &lt;xsl:with-param name=&quot;date&quot; select=&quot;xs:date(substring-before($date,&apos;T&apos;))&quot; /&gt;     &lt;/xsl:call-template&gt;    &lt;/xsl:when&gt;    &lt;xsl:otherwise&gt;      &lt;xsl:value-of select=&quot;concat(year-from-date($date),format-number(month-from-date($date),&apos;00&apos;),format-number(day-from-date($date),&apos;00&apos;))&quot; /&gt;    &lt;/xsl:otherwise&gt;   &lt;/xsl:choose&gt;      &lt;/xsl:if&gt; &lt;/xsl:template&gt;  &lt;!-- Generate HL7-formatted time --&gt; &lt;xsl:template name=&quot;hl7Time&quot;&gt;  &lt;xsl:param name=&quot;time&quot; /&gt;  &lt;xsl:if test=&quot;$time != &apos;&apos;&quot;&gt;   &lt;xsl:value-of select=&quot;concat(format-number(hours-from-time($time),&apos;00&apos;),format-number(minutes-from-time($time),&apos;00&apos;),format-number(floor(seconds-from-time($time)),&apos;00&apos;))&quot; /&gt;  &lt;/xsl:if&gt; &lt;/xsl:template&gt;  &lt;/xsl:stylesheet&gt;" creator="1" date_created="2006-10-01 09:15:13.0" changed_by="1" date_changed="2006-10-01 09:15:22.0" retired="false"/>
  <form form_id="14" name="AMPATH Adult Return Visit Form" version="4.0" build="24" published="0" description="AMPATH Adult Return Visit Form - initial version" xslt="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;  &lt;!-- OpenMRS FormEntry Form HL7 Translation  This XSLT is used to translate OpenMRS forms from XML into HL7 2.5 format  @author Burke Mamlin, MD @author Ben Wolfe @version 1.9.4  1.9.4 - add support for message uid (as HL7 control id) and transform of patient.health_center to Discharge to Location (PV1-37) 1.9.3 - fixed rounding error on timestamp (tenths of seconds getting rounded up, causing &quot;60&quot; seconds in some cases)  1.9.2 - first generally useful version --&gt;  &lt;xsl:stylesheet version=&quot;2.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot; xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:fn=&quot;http://www.w3.org/2005/xpath-functions&quot; xmlns:xdt=&quot;http://www.w3.org/2005/xpath-datatypes&quot;&gt;  &lt;xsl:output method=&quot;text&quot; version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; indent=&quot;no&quot;/&gt;  &lt;xsl:variable name=&quot;SENDING-APPLICATION&quot;&gt;FORMENTRY&lt;/xsl:variable&gt; &lt;xsl:variable name=&quot;SENDING-FACILITY&quot;&gt;AMRS.ELD&lt;/xsl:variable&gt; &lt;xsl:variable name=&quot;RECEIVING-APPLICATION&quot;&gt;HL7LISTENER&lt;/xsl:variable&gt; &lt;xsl:variable name=&quot;RECEIVING-FACILITY&quot;&gt;AMRS.ELD&lt;/xsl:variable&gt; &lt;xsl:variable name=&quot;PATIENT-AUTHORITY&quot;&gt;&lt;/xsl:variable&gt; &lt;!-- leave blank for internal id, max 20 characters --&gt;                                                        &lt;!-- for now, must match patient_identifier_type.name --&gt; &lt;xsl:variable name=&quot;FORM-AUTHORITY&quot;&gt;AMRS.ELD.FORMID&lt;/xsl:variable&gt; &lt;!-- max 20 characters --&gt;  &lt;xsl:template match=&quot;/&quot;&gt;  &lt;xsl:apply-templates /&gt; &lt;/xsl:template&gt;  &lt;!-- Form template --&gt; &lt;xsl:template match=&quot;form&quot;&gt;  &lt;!-- MSH Header --&gt;  &lt;xsl:text&gt;MSH|^~\&amp;amp;&lt;/xsl:text&gt;   &lt;!-- Message header, field separator, and encoding characters --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-3 Sending application --&gt;  &lt;xsl:value-of select=&quot;$SENDING-APPLICATION&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-4 Sending facility --&gt;  &lt;xsl:value-of select=&quot;$SENDING-FACILITY&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-5 Receiving application --&gt;  &lt;xsl:value-of select=&quot;$RECEIVING-APPLICATION&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-6 Receiving facility --&gt;  &lt;xsl:value-of select=&quot;$RECEIVING-FACILITY&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-7 Date/time message sent --&gt;  &lt;xsl:call-template name=&quot;hl7Timestamp&quot;&gt;   &lt;xsl:with-param name=&quot;date&quot; select=&quot;current-dateTime()&quot; /&gt;  &lt;/xsl:call-template&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-8 Security --&gt;  &lt;xsl:text&gt;|ORU^R01&lt;/xsl:text&gt;       &lt;!-- MSH-9 Message type ^ Event type (observation report unsolicited) --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-10 Message control ID --&gt;  &lt;xsl:choose&gt;   &lt;xsl:when test=&quot;header/uid&quot;&gt;    &lt;xsl:value-of select=&quot;header/uid&quot; /&gt;   &lt;/xsl:when&gt;   &lt;xsl:otherwise&gt;    &lt;xsl:value-of select=&quot;patient/patient.patient_id&quot; /&gt;    &lt;xsl:call-template name=&quot;hl7Timestamp&quot;&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;current-dateTime()&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:otherwise&gt;  &lt;/xsl:choose&gt;  &lt;xsl:text&gt;|P&lt;/xsl:text&gt;             &lt;!-- MSH-11 Processing ID --&gt;  &lt;xsl:text&gt;|2.5&lt;/xsl:text&gt;           &lt;!-- MSH-12 HL7 version --&gt;  &lt;xsl:text&gt;|1&lt;/xsl:text&gt;             &lt;!-- MSH-13 Message sequence number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-14 Continuation Pointer --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-15 Accept Acknowledgement Type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-16 Application Acknowledgement Type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-17 Country Code --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-18 Character Set --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-19 Principal Language of Message --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-20 Alternate Character Set Handling Scheme --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-21 Message Profile Identifier --&gt;  &lt;xsl:value-of select=&quot;@id&quot; /&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;  &lt;xsl:value-of select=&quot;$FORM-AUTHORITY&quot; /&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;   &lt;!-- PID header --&gt;  &lt;xsl:text&gt;PID&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-1 Set ID --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-2 (deprecated) Patient ID --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-3 Patient Identifier List --&gt;  &lt;xsl:call-template name=&quot;patient_id&quot;&gt;   &lt;xsl:with-param name=&quot;pid&quot; select=&quot;patient/patient.patient_id&quot; /&gt;   &lt;xsl:with-param name=&quot;auth&quot; select=&quot;$PATIENT-AUTHORITY&quot; /&gt;   &lt;xsl:with-param name=&quot;type&quot; select=&quot;L&quot; /&gt;  &lt;/xsl:call-template&gt;  &lt;xsl:if test=&quot;patient/patient.previous_mrn and string-length(patient/patient.previous_mrn) &gt; 0&quot;&gt;   &lt;xsl:text&gt;~&lt;/xsl:text&gt;   &lt;xsl:call-template name=&quot;patient_id&quot;&gt;    &lt;xsl:with-param name=&quot;pid&quot; select=&quot;patient/patient.previous_mrn&quot; /&gt;    &lt;xsl:with-param name=&quot;auth&quot; select=&quot;$PATIENT-AUTHORITY&quot; /&gt;    &lt;xsl:with-param name=&quot;type&quot; select=&quot;PRIOR&quot; /&gt;   &lt;/xsl:call-template&gt;  &lt;/xsl:if&gt;  &lt;!-- Additional patient identifiers --&gt;  &lt;!-- This example is for an MTCT-PLUS identifier used in the AMPATH project in Kenya (skipped if not present) --&gt;  &lt;xsl:if test=&quot;patient/patient.mtctplus_id and string-length(patient/patient.mtctplus_id) &gt; 0&quot;&gt;   &lt;xsl:text&gt;~&lt;/xsl:text&gt;   &lt;xsl:call-template name=&quot;patient_id&quot;&gt;    &lt;xsl:with-param name=&quot;pid&quot; select=&quot;patient/patient.mtctplus_id&quot; /&gt;    &lt;xsl:with-param name=&quot;auth&quot; select=&quot;$PATIENT-AUTHORITY&quot; /&gt;    &lt;xsl:with-param name=&quot;type&quot; select=&quot;MTCTPLUS&quot; /&gt;   &lt;/xsl:call-template&gt;  &lt;/xsl:if&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-4 (deprecated) Alternate patient ID --&gt;  &lt;!-- PID-5 Patient name --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- Family name --&gt;  &lt;xsl:value-of select=&quot;patient/patient.family_name&quot; /&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Given name --&gt;  &lt;xsl:value-of select=&quot;patient/patient.given_name&quot; /&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Middle name --&gt;  &lt;xsl:value-of select=&quot;patient/patient.middle_name&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-6 Mother&apos;s maiden name --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-7 Date/Time of Birth --&gt;  &lt;xsl:value-of select=&quot;patient/patient.date_of_birth&quot; /&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;    &lt;!-- PV1 header --&gt;  &lt;xsl:text&gt;PV1&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-1 Sub ID --&gt;  &lt;xsl:text&gt;|O&lt;/xsl:text&gt;             &lt;!-- PV1-2 Patient class (O = outpatient) --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-3 Patient location --&gt;  &lt;xsl:value-of select=&quot;encounter/encounter.location_id&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-4 Admission type (2 = return) --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-5 Pre-Admin Number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-6 Prior Patient Location --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-7 Attending Doctor --&gt;  &lt;xsl:value-of select=&quot;encounter/encounter.provider_id&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-8 Referring Doctor --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-9 Consulting Doctor --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-10 Hospital Service --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-11 Temporary Location --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-12 Preadmin Test Indicator --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-13 Re-adminssion Indicator --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-14 Admit Source --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-15 Ambulatory Status --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-16 VIP Indicator --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-17 Admitting Doctor --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-18 Patient Type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-19 Visit Number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-20 Financial Class --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-21 Charge Price Indicator --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-22 Courtesy Code --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-23 Credit Rating --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-24 Contract Code --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-25 Contract Effective Date --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-26 Contract Amount --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-27 Contract Period --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-28 Interest Code --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-29 Transfer to Bad Debt Code --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-30 Transfer to Bad Debt Date --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-31 Bad Debt Agency Code --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-31 Bad Debt Transfer Amount --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-33 Bad Debt Recovery Amount --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-34 Delete Account Indicator --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-35 Delete Account Date --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-36 Discharge Disposition --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-37 Discharge To Location --&gt;  &lt;xsl:if test=&quot;patient/patient.health_center&quot;&gt;   &lt;xsl:value-of select=&quot;replace(patient/patient.health_center,&apos;\^&apos;,&apos;&amp;amp;&apos;)&quot; /&gt;  &lt;/xsl:if&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-38 Diet Type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-39 Servicing Facility --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-40 Bed Status --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-41 Account Status --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-42 Pending Location --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-43 Prior Temporary Location --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-44 Admit Date/Time --&gt;  &lt;xsl:call-template name=&quot;hl7Date&quot;&gt;   &lt;xsl:with-param name=&quot;date&quot; select=&quot;encounter/encounter.encounter_datetime&quot; /&gt;  &lt;/xsl:call-template&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-45 Discharge Date/Time --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-46 Current Patient Balance --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-47 Total Charges --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-48 Total Adjustments --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-49 Total Payments --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-50 Alternate Visit ID --&gt;  &lt;xsl:text&gt;|V&lt;/xsl:text&gt;             &lt;!-- PV1-51 Visit Indicator --&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;   &lt;!-- We use encounter date as the timestamp for each observation --&gt;  &lt;xsl:variable name=&quot;encounterTimestamp&quot;&gt;   &lt;xsl:call-template name=&quot;hl7Date&quot;&gt;    &lt;xsl:with-param name=&quot;date&quot; select=&quot;encounter/encounter.encounter_datetime&quot; /&gt;   &lt;/xsl:call-template&gt;  &lt;/xsl:variable&gt;    &lt;!-- ORC Common Order Segment --&gt;  &lt;xsl:text&gt;ORC&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;  &lt;xsl:text&gt;|RE&lt;/xsl:text&gt;            &lt;!-- ORC-1 Order Control (RE = obs to follow) --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-2 Placer Order Number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-3 Filler Order Number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-4 Placer Group Number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-5 Order Status --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-6 Response Flag --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-7 Quantity/Timing --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-8 Parent --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-9 Date/Time of Transaction --&gt;  &lt;xsl:call-template name=&quot;hl7Timestamp&quot;&gt;   &lt;xsl:with-param name=&quot;date&quot; select=&quot;xs:dateTime(header/date_entered)&quot; /&gt;  &lt;/xsl:call-template&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-10 Entered By --&gt;  &lt;xsl:value-of select=&quot;header/enterer&quot; /&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;   &lt;!-- Observation(s) --&gt;  &lt;xsl:variable name=&quot;obsList&quot; select=&quot;obs/*[(@openmrs_concept and value and value/text() != &apos;&apos;) or *[@openmrs_concept and text()=&apos;true&apos;]]&quot; /&gt;  &lt;xsl:variable name=&quot;obsListCount&quot; select=&quot;count($obsList)&quot; as=&quot;xs:integer&quot; /&gt;  &lt;!-- Observation OBR --&gt;  &lt;xsl:text&gt;OBR&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-1 Set ID --&gt;  &lt;xsl:text&gt;1&lt;/xsl:text&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-2 Placer order number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-3 Filler order number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-4 OBR concept --&gt;  &lt;xsl:value-of select=&quot;obs/@openmrs_concept&quot; /&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;   &lt;!-- observation OBXs --&gt;  &lt;xsl:for-each select=&quot;$obsList&quot;&gt;   &lt;xsl:choose&gt;    &lt;xsl:when test=&quot;value&quot;&gt;     &lt;xsl:call-template name=&quot;obsObx&quot;&gt;      &lt;xsl:with-param name=&quot;setId&quot; select=&quot;position()&quot; /&gt;      &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;@openmrs_datatype&quot; /&gt;      &lt;xsl:with-param name=&quot;units&quot; select=&quot;@openmrs_units&quot; /&gt;      &lt;xsl:with-param name=&quot;concept&quot; select=&quot;@openmrs_concept&quot; /&gt;      &lt;xsl:with-param name=&quot;date&quot; select=&quot;date/text()&quot; /&gt;      &lt;xsl:with-param name=&quot;time&quot; select=&quot;time/text()&quot; /&gt;      &lt;xsl:with-param name=&quot;value&quot; select=&quot;value&quot; /&gt;      &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;     &lt;/xsl:call-template&gt;    &lt;/xsl:when&gt;    &lt;xsl:otherwise&gt;     &lt;xsl:variable name=&quot;setId&quot; select=&quot;position()&quot; /&gt;     &lt;xsl:for-each select=&quot;*[@openmrs_concept and text() = &apos;true&apos;]&quot;&gt;      &lt;xsl:call-template name=&quot;obsObx&quot;&gt;       &lt;xsl:with-param name=&quot;setId&quot; select=&quot;$setId&quot; /&gt;       &lt;xsl:with-param name=&quot;subId&quot; select=&quot;concat($setId,position())&quot; /&gt;       &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;../@openmrs_datatype&quot; /&gt;       &lt;xsl:with-param name=&quot;units&quot; select=&quot;../@openmrs_units&quot; /&gt;       &lt;xsl:with-param name=&quot;concept&quot; select=&quot;../@openmrs_concept&quot; /&gt;       &lt;xsl:with-param name=&quot;date&quot; select=&quot;../date/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;time&quot; select=&quot;../time/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;value&quot; select=&quot;@openmrs_concept&quot; /&gt;       &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;      &lt;/xsl:call-template&gt;     &lt;/xsl:for-each&gt;    &lt;/xsl:otherwise&gt;   &lt;/xsl:choose&gt;  &lt;/xsl:for-each&gt;    &lt;!-- Grouped observation(s) --&gt;  &lt;xsl:variable name=&quot;obsGroupList&quot; select=&quot;obs/*[@openmrs_concept and not(date) and *[(@openmrs_concept and value and value/text() != &apos;&apos;) or *[@openmrs_concept and text()=&apos;true&apos;]]]&quot; /&gt;  &lt;xsl:variable name=&quot;obsGroupListCount&quot; select=&quot;count($obsGroupList)&quot; as=&quot;xs:integer&quot; /&gt;  &lt;xsl:for-each select=&quot;$obsGroupList&quot;&gt;   &lt;!-- Observation OBR --&gt;   &lt;xsl:text&gt;OBR&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-1 Set ID --&gt;   &lt;xsl:value-of select=&quot;$obsListCount + position()&quot; /&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-2 Placer order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-3 Filler order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-4 OBR concept --&gt;   &lt;xsl:value-of select=&quot;@openmrs_concept&quot; /&gt;   &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;      &lt;!-- Generate OBXs --&gt;   &lt;xsl:for-each select=&quot;*[(@openmrs_concept and value and value/text() != &apos;&apos;) or *[@openmrs_concept and text()=&apos;true&apos;]]&quot;&gt;    &lt;xsl:choose&gt;     &lt;xsl:when test=&quot;value&quot;&gt;      &lt;xsl:call-template name=&quot;obsObx&quot;&gt;       &lt;xsl:with-param name=&quot;setId&quot; select=&quot;position()&quot; /&gt;       &lt;xsl:with-param name=&quot;subId&quot; select=&quot;1&quot; /&gt;       &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;@openmrs_datatype&quot; /&gt;       &lt;xsl:with-param name=&quot;units&quot; select=&quot;@openmrs_units&quot; /&gt;       &lt;xsl:with-param name=&quot;concept&quot; select=&quot;@openmrs_concept&quot; /&gt;       &lt;xsl:with-param name=&quot;date&quot; select=&quot;date/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;time&quot; select=&quot;time/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;value&quot; select=&quot;value&quot; /&gt;       &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;      &lt;/xsl:call-template&gt;     &lt;/xsl:when&gt;     &lt;xsl:otherwise&gt;      &lt;xsl:variable name=&quot;setId&quot; select=&quot;position()&quot; /&gt;      &lt;xsl:for-each select=&quot;*[@openmrs_concept and text() = &apos;true&apos;]&quot;&gt;       &lt;xsl:call-template name=&quot;obsObx&quot;&gt;        &lt;xsl:with-param name=&quot;setId&quot; select=&quot;$setId&quot; /&gt;        &lt;xsl:with-param name=&quot;subId&quot; select=&quot;concat(&apos;1.&apos;,position())&quot; /&gt;        &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;../@openmrs_datatype&quot; /&gt;        &lt;xsl:with-param name=&quot;units&quot; select=&quot;../@openmrs_units&quot; /&gt;        &lt;xsl:with-param name=&quot;concept&quot; select=&quot;../@openmrs_concept&quot; /&gt;        &lt;xsl:with-param name=&quot;date&quot; select=&quot;../date/text()&quot; /&gt;        &lt;xsl:with-param name=&quot;time&quot; select=&quot;../time/text()&quot; /&gt;        &lt;xsl:with-param name=&quot;value&quot; select=&quot;@openmrs_concept&quot; /&gt;        &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;       &lt;/xsl:call-template&gt;      &lt;/xsl:for-each&gt;     &lt;/xsl:otherwise&gt;    &lt;/xsl:choose&gt;   &lt;/xsl:for-each&gt;  &lt;/xsl:for-each&gt;   &lt;!-- Problem list(s) --&gt;  &lt;xsl:variable name=&quot;problemList&quot; select=&quot;problem_list/*[value[text() != &apos;&apos;]]&quot; /&gt;  &lt;xsl:variable name=&quot;problemListCount&quot; select=&quot;count($problemList)&quot; as=&quot;xs:integer&quot; /&gt;  &lt;xsl:if test=&quot;$problemList&quot;&gt;   &lt;!-- Problem list OBR --&gt;   &lt;xsl:text&gt;OBR&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-1 Set ID --&gt;   &lt;xsl:value-of select=&quot;$obsListCount + $obsGroupListCount + 1&quot; /&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-2 Placer order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-3 Filler order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-4 OBR concept --&gt;   &lt;xsl:value-of select=&quot;problem_list/@openmrs_concept&quot; /&gt;   &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;    &lt;!-- Problem list OBXs --&gt;   &lt;xsl:for-each select=&quot;$problemList&quot;&gt;    &lt;xsl:call-template name=&quot;obsObx&quot;&gt;     &lt;xsl:with-param name=&quot;setId&quot; select=&quot;position()&quot; /&gt;     &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;&apos;CWE&apos;&quot; /&gt;     &lt;xsl:with-param name=&quot;concept&quot; select=&quot;@openmrs_concept&quot; /&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;date/text()&quot; /&gt;     &lt;xsl:with-param name=&quot;time&quot; select=&quot;time/text()&quot; /&gt;     &lt;xsl:with-param name=&quot;value&quot; select=&quot;value&quot; /&gt;     &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;    &lt;/xsl:call-template&gt;     &lt;/xsl:for-each&gt;  &lt;/xsl:if&gt;    &lt;!-- Orders --&gt;  &lt;xsl:variable name=&quot;orderList&quot; select=&quot;orders/*[*[@openmrs_concept and ((value and value/text() != &apos;&apos;) or *[@openmrs_concept and text() = &apos;true&apos;])]]&quot; /&gt;  &lt;xsl:variable name=&quot;orderListCount&quot; select=&quot;count($orderList)&quot; as=&quot;xs:integer&quot; /&gt;  &lt;xsl:for-each select=&quot;$orderList&quot;&gt;   &lt;!-- Order section OBR --&gt;   &lt;xsl:text&gt;OBR&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-1 Set ID --&gt;   &lt;xsl:value-of select=&quot;$obsListCount + $obsGroupListCount + $problemListCount + 1&quot; /&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-2 Placer order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-3 Filler order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-4 OBR concept --&gt;   &lt;xsl:value-of select=&quot;@openmrs_concept&quot; /&gt;   &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;     &lt;!-- Order OBXs --&gt;   &lt;xsl:for-each select=&quot;*[@openmrs_concept and ((value and value/text() != &apos;&apos;) or *[@openmrs_concept and text() = &apos;true&apos;])]&quot;&gt;    &lt;xsl:choose&gt;     &lt;xsl:when test=&quot;value&quot;&gt;      &lt;xsl:call-template name=&quot;obsObx&quot;&gt;       &lt;xsl:with-param name=&quot;setId&quot; select=&quot;position()&quot; /&gt;       &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;@openmrs_datatype&quot; /&gt;       &lt;xsl:with-param name=&quot;units&quot; select=&quot;@openmrs_units&quot; /&gt;       &lt;xsl:with-param name=&quot;concept&quot; select=&quot;@openmrs_concept&quot; /&gt;       &lt;xsl:with-param name=&quot;date&quot; select=&quot;date/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;time&quot; select=&quot;time/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;value&quot; select=&quot;value&quot; /&gt;       &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;      &lt;/xsl:call-template&gt;     &lt;/xsl:when&gt;     &lt;xsl:otherwise&gt;      &lt;xsl:variable name=&quot;setId&quot; select=&quot;position()&quot; /&gt;      &lt;xsl:for-each select=&quot;*[@openmrs_concept and text() = &apos;true&apos;]&quot;&gt;       &lt;xsl:call-template name=&quot;obsObx&quot;&gt;        &lt;xsl:with-param name=&quot;setId&quot; select=&quot;$setId&quot; /&gt;        &lt;xsl:with-param name=&quot;subId&quot; select=&quot;position()&quot; /&gt;        &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;../@openmrs_datatype&quot; /&gt;        &lt;xsl:with-param name=&quot;units&quot; select=&quot;../@openmrs_units&quot; /&gt;        &lt;xsl:with-param name=&quot;concept&quot; select=&quot;../@openmrs_concept&quot; /&gt;        &lt;xsl:with-param name=&quot;date&quot; select=&quot;../date/text()&quot; /&gt;        &lt;xsl:with-param name=&quot;time&quot; select=&quot;../time/text()&quot; /&gt;        &lt;xsl:with-param name=&quot;value&quot; select=&quot;@openmrs_concept&quot; /&gt;        &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;       &lt;/xsl:call-template&gt;      &lt;/xsl:for-each&gt;     &lt;/xsl:otherwise&gt;    &lt;/xsl:choose&gt;   &lt;/xsl:for-each&gt;   &lt;/xsl:for-each&gt;   &lt;/xsl:template&gt;  &lt;!-- Patient Identifier (CX) generator --&gt; &lt;xsl:template name=&quot;patient_id&quot;&gt;  &lt;xsl:param name=&quot;pid&quot; /&gt;  &lt;xsl:param name=&quot;auth&quot; /&gt;  &lt;xsl:param name=&quot;type&quot; /&gt;  &lt;xsl:value-of select=&quot;$pid&quot; /&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Check digit --&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Check Digit Scheme --&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Assigning Authority --&gt;  &lt;xsl:value-of select=&quot;$auth&quot; /&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Identifier Type --&gt;  &lt;xsl:value-of select=&quot;$type&quot; /&gt; &lt;/xsl:template&gt;  &lt;!-- OBX Generator --&gt; &lt;xsl:template name=&quot;obsObx&quot;&gt;  &lt;xsl:param name=&quot;setId&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;subId&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;datatype&quot; required=&quot;yes&quot; /&gt;  &lt;xsl:param name=&quot;concept&quot; required=&quot;yes&quot; /&gt;  &lt;xsl:param name=&quot;date&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;time&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;value&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;units&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;encounterTimestamp&quot; required=&quot;yes&quot; /&gt;  &lt;xsl:text&gt;OBX&lt;/xsl:text&gt;                     &lt;!-- Message type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Set ID --&gt;  &lt;xsl:value-of select=&quot;$setId&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Observation datatype --&gt;  &lt;xsl:choose&gt;   &lt;xsl:when test=&quot;$datatype = &apos;BIT&apos;&quot;&gt;    &lt;xsl:text&gt;NM&lt;/xsl:text&gt;   &lt;/xsl:when&gt;   &lt;xsl:otherwise&gt;    &lt;xsl:value-of select=&quot;$datatype&quot; /&gt;   &lt;/xsl:otherwise&gt;  &lt;/xsl:choose&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Concept (what was observed --&gt;  &lt;xsl:value-of select=&quot;$concept&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Sub-ID --&gt;  &lt;xsl:value-of select=&quot;$subId&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Value --&gt;  &lt;xsl:choose&gt;   &lt;xsl:when test=&quot;$datatype = &apos;TS&apos;&quot;&gt;    &lt;xsl:call-template name=&quot;hl7Timestamp&quot;&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;$value&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:when&gt;   &lt;xsl:when test=&quot;$datatype = &apos;DT&apos;&quot;&gt;    &lt;xsl:call-template name=&quot;hl7Date&quot;&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;$value&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:when&gt;   &lt;xsl:when test=&quot;$datatype = &apos;TM&apos;&quot;&gt;    &lt;xsl:call-template name=&quot;hl7Time&quot;&gt;     &lt;xsl:with-param name=&quot;time&quot; select=&quot;$value&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:when&gt;   &lt;xsl:when test=&quot;$datatype = &apos;BIT&apos;&quot;&gt;    &lt;xsl:choose&gt;     &lt;xsl:when test=&quot;$value = &apos;0&apos; or upper-case($value) = &apos;FALSE&apos;&quot;&gt;0&lt;/xsl:when&gt;     &lt;xsl:otherwise&gt;1&lt;/xsl:otherwise&gt;    &lt;/xsl:choose&gt;   &lt;/xsl:when&gt;   &lt;xsl:otherwise&gt;    &lt;xsl:value-of select=&quot;$value&quot; /&gt;   &lt;/xsl:otherwise&gt;  &lt;/xsl:choose&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Units --&gt;  &lt;xsl:value-of select=&quot;$units&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Reference range --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Abnormal flags --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Probability --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Nature of abnormal test --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Observation result status --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Effective date --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- User defined access checks --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Date time of observation --&gt;  &lt;xsl:choose&gt;   &lt;xsl:when test=&quot;$date and $time&quot;&gt;    &lt;xsl:call-template name=&quot;hl7Timestamp&quot;&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;dateTime($date,$time)&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:when&gt;   &lt;xsl:when test=&quot;$date&quot;&gt;    &lt;xsl:call-template name=&quot;hl7Date&quot;&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;$date&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:when&gt;   &lt;xsl:otherwise&gt;    &lt;xsl:value-of select=&quot;$encounterTimestamp&quot; /&gt;   &lt;/xsl:otherwise&gt;  &lt;/xsl:choose&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt; &lt;/xsl:template&gt;  &lt;!-- Generate HL7-formatted timestamp --&gt; &lt;xsl:template name=&quot;hl7Timestamp&quot;&gt;  &lt;xsl:param name=&quot;date&quot; /&gt;  &lt;xsl:if test=&quot;string($date) != &apos;&apos;&quot;&gt;   &lt;xsl:value-of select=&quot;concat(year-from-dateTime($date),format-number(month-from-dateTime($date),&apos;00&apos;),format-number(day-from-dateTime($date),&apos;00&apos;),format-number(hours-from-dateTime($date),&apos;00&apos;),format-number(minutes-from-dateTime($date),&apos;00&apos;),format-number(floor(seconds-from-dateTime($date)),&apos;00&apos;))&quot; /&gt;  &lt;/xsl:if&gt; &lt;/xsl:template&gt;  &lt;!-- Generate HL7-formatted date --&gt; &lt;xsl:template name=&quot;hl7Date&quot;&gt;  &lt;xsl:param name=&quot;date&quot; /&gt;  &lt;xsl:if test=&quot;string($date) != &apos;&apos;&quot;&gt;   &lt;xsl:choose&gt;    &lt;xsl:when test=&quot;contains(string($date),&apos;T&apos;)&quot;&gt;     &lt;xsl:call-template name=&quot;hl7Date&quot;&gt;      &lt;xsl:with-param name=&quot;date&quot; select=&quot;xs:date(substring-before($date,&apos;T&apos;))&quot; /&gt;     &lt;/xsl:call-template&gt;    &lt;/xsl:when&gt;    &lt;xsl:otherwise&gt;      &lt;xsl:value-of select=&quot;concat(year-from-date($date),format-number(month-from-date($date),&apos;00&apos;),format-number(day-from-date($date),&apos;00&apos;))&quot; /&gt;    &lt;/xsl:otherwise&gt;   &lt;/xsl:choose&gt;      &lt;/xsl:if&gt; &lt;/xsl:template&gt;  &lt;!-- Generate HL7-formatted time --&gt; &lt;xsl:template name=&quot;hl7Time&quot;&gt;  &lt;xsl:param name=&quot;time&quot; /&gt;  &lt;xsl:if test=&quot;$time != &apos;&apos;&quot;&gt;   &lt;xsl:value-of select=&quot;concat(format-number(hours-from-time($time),&apos;00&apos;),format-number(minutes-from-time($time),&apos;00&apos;),format-number(floor(seconds-from-time($time)),&apos;00&apos;))&quot; /&gt;  &lt;/xsl:if&gt; &lt;/xsl:template&gt;  &lt;/xsl:stylesheet&gt;" creator="2" date_created="2005-02-22 23:06:27.0" changed_by="54709" date_changed="2007-10-24 14:52:00.0" retired="false"/>
  <form form_id="15" name="AMPATH Adult Initial Visit Form" version="4.1" build="45" published="0" description="AMPATH Adult Initial Visit Form - first version" xslt="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;  &lt;!-- OpenMRS FormEntry Form HL7 Translation  This XSLT is used to translate OpenMRS forms from XML into HL7 2.5 format  @author Burke Mamlin, MD @author Ben Wolfe @version 1.9.4  1.9.4 - add support for message uid (as HL7 control id) and transform of patient.health_center to Discharge to Location (PV1-37) 1.9.3 - fixed rounding error on timestamp (tenths of seconds getting rounded up, causing &quot;60&quot; seconds in some cases)  1.9.2 - first generally useful version --&gt;  &lt;xsl:stylesheet version=&quot;2.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot; xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:fn=&quot;http://www.w3.org/2005/xpath-functions&quot; xmlns:xdt=&quot;http://www.w3.org/2005/xpath-datatypes&quot;&gt;  &lt;xsl:output method=&quot;text&quot; version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; indent=&quot;no&quot;/&gt;  &lt;xsl:variable name=&quot;SENDING-APPLICATION&quot;&gt;FORMENTRY&lt;/xsl:variable&gt; &lt;xsl:variable name=&quot;SENDING-FACILITY&quot;&gt;AMRS.ELD&lt;/xsl:variable&gt; &lt;xsl:variable name=&quot;RECEIVING-APPLICATION&quot;&gt;HL7LISTENER&lt;/xsl:variable&gt; &lt;xsl:variable name=&quot;RECEIVING-FACILITY&quot;&gt;AMRS.ELD&lt;/xsl:variable&gt; &lt;xsl:variable name=&quot;PATIENT-AUTHORITY&quot;&gt;&lt;/xsl:variable&gt; &lt;!-- leave blank for internal id, max 20 characters --&gt;                                                        &lt;!-- for now, must match patient_identifier_type.name --&gt; &lt;xsl:variable name=&quot;FORM-AUTHORITY&quot;&gt;AMRS.ELD.FORMID&lt;/xsl:variable&gt; &lt;!-- max 20 characters --&gt;  &lt;xsl:template match=&quot;/&quot;&gt;  &lt;xsl:apply-templates /&gt; &lt;/xsl:template&gt;  &lt;!-- Form template --&gt; &lt;xsl:template match=&quot;form&quot;&gt;  &lt;!-- MSH Header --&gt;  &lt;xsl:text&gt;MSH|^~\&amp;amp;&lt;/xsl:text&gt;   &lt;!-- Message header, field separator, and encoding characters --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-3 Sending application --&gt;  &lt;xsl:value-of select=&quot;$SENDING-APPLICATION&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-4 Sending facility --&gt;  &lt;xsl:value-of select=&quot;$SENDING-FACILITY&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-5 Receiving application --&gt;  &lt;xsl:value-of select=&quot;$RECEIVING-APPLICATION&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-6 Receiving facility --&gt;  &lt;xsl:value-of select=&quot;$RECEIVING-FACILITY&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-7 Date/time message sent --&gt;  &lt;xsl:call-template name=&quot;hl7Timestamp&quot;&gt;   &lt;xsl:with-param name=&quot;date&quot; select=&quot;current-dateTime()&quot; /&gt;  &lt;/xsl:call-template&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-8 Security --&gt;  &lt;xsl:text&gt;|ORU^R01&lt;/xsl:text&gt;       &lt;!-- MSH-9 Message type ^ Event type (observation report unsolicited) --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-10 Message control ID --&gt;  &lt;xsl:choose&gt;   &lt;xsl:when test=&quot;header/uid&quot;&gt;    &lt;xsl:value-of select=&quot;header/uid&quot; /&gt;   &lt;/xsl:when&gt;   &lt;xsl:otherwise&gt;    &lt;xsl:value-of select=&quot;patient/patient.patient_id&quot; /&gt;    &lt;xsl:call-template name=&quot;hl7Timestamp&quot;&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;current-dateTime()&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:otherwise&gt;  &lt;/xsl:choose&gt;  &lt;xsl:text&gt;|P&lt;/xsl:text&gt;             &lt;!-- MSH-11 Processing ID --&gt;  &lt;xsl:text&gt;|2.5&lt;/xsl:text&gt;           &lt;!-- MSH-12 HL7 version --&gt;  &lt;xsl:text&gt;|1&lt;/xsl:text&gt;             &lt;!-- MSH-13 Message sequence number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-14 Continuation Pointer --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-15 Accept Acknowledgement Type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-16 Application Acknowledgement Type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-17 Country Code --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-18 Character Set --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-19 Principal Language of Message --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-20 Alternate Character Set Handling Scheme --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- MSH-21 Message Profile Identifier --&gt;  &lt;xsl:value-of select=&quot;@id&quot; /&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;  &lt;xsl:value-of select=&quot;$FORM-AUTHORITY&quot; /&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;   &lt;!-- PID header --&gt;  &lt;xsl:text&gt;PID&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-1 Set ID --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-2 (deprecated) Patient ID --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-3 Patient Identifier List --&gt;  &lt;xsl:call-template name=&quot;patient_id&quot;&gt;   &lt;xsl:with-param name=&quot;pid&quot; select=&quot;patient/patient.patient_id&quot; /&gt;   &lt;xsl:with-param name=&quot;auth&quot; select=&quot;$PATIENT-AUTHORITY&quot; /&gt;   &lt;xsl:with-param name=&quot;type&quot; select=&quot;L&quot; /&gt;  &lt;/xsl:call-template&gt;  &lt;xsl:if test=&quot;patient/patient.previous_mrn and string-length(patient/patient.previous_mrn) &gt; 0&quot;&gt;   &lt;xsl:text&gt;~&lt;/xsl:text&gt;   &lt;xsl:call-template name=&quot;patient_id&quot;&gt;    &lt;xsl:with-param name=&quot;pid&quot; select=&quot;patient/patient.previous_mrn&quot; /&gt;    &lt;xsl:with-param name=&quot;auth&quot; select=&quot;$PATIENT-AUTHORITY&quot; /&gt;    &lt;xsl:with-param name=&quot;type&quot; select=&quot;PRIOR&quot; /&gt;   &lt;/xsl:call-template&gt;  &lt;/xsl:if&gt;  &lt;!-- Additional patient identifiers --&gt;  &lt;!-- This example is for an MTCT-PLUS identifier used in the AMPATH project in Kenya (skipped if not present) --&gt;  &lt;xsl:if test=&quot;patient/patient.mtctplus_id and string-length(patient/patient.mtctplus_id) &gt; 0&quot;&gt;   &lt;xsl:text&gt;~&lt;/xsl:text&gt;   &lt;xsl:call-template name=&quot;patient_id&quot;&gt;    &lt;xsl:with-param name=&quot;pid&quot; select=&quot;patient/patient.mtctplus_id&quot; /&gt;    &lt;xsl:with-param name=&quot;auth&quot; select=&quot;$PATIENT-AUTHORITY&quot; /&gt;    &lt;xsl:with-param name=&quot;type&quot; select=&quot;MTCTPLUS&quot; /&gt;   &lt;/xsl:call-template&gt;  &lt;/xsl:if&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-4 (deprecated) Alternate patient ID --&gt;  &lt;!-- PID-5 Patient name --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- Family name --&gt;  &lt;xsl:value-of select=&quot;patient/patient.family_name&quot; /&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Given name --&gt;  &lt;xsl:value-of select=&quot;patient/patient.given_name&quot; /&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Middle name --&gt;  &lt;xsl:value-of select=&quot;patient/patient.middle_name&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-6 Mother&apos;s maiden name --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PID-7 Date/Time of Birth --&gt;  &lt;xsl:value-of select=&quot;patient/patient.date_of_birth&quot; /&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;    &lt;!-- PV1 header --&gt;  &lt;xsl:text&gt;PV1&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-1 Sub ID --&gt;  &lt;xsl:text&gt;|O&lt;/xsl:text&gt;             &lt;!-- PV1-2 Patient class (O = outpatient) --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-3 Patient location --&gt;  &lt;xsl:value-of select=&quot;encounter/encounter.location_id&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-4 Admission type (2 = return) --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-5 Pre-Admin Number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-6 Prior Patient Location --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-7 Attending Doctor --&gt;  &lt;xsl:value-of select=&quot;encounter/encounter.provider_id&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-8 Referring Doctor --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-9 Consulting Doctor --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-10 Hospital Service --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-11 Temporary Location --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-12 Preadmin Test Indicator --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-13 Re-adminssion Indicator --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-14 Admit Source --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-15 Ambulatory Status --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-16 VIP Indicator --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-17 Admitting Doctor --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-18 Patient Type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-19 Visit Number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-20 Financial Class --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-21 Charge Price Indicator --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-22 Courtesy Code --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-23 Credit Rating --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-24 Contract Code --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-25 Contract Effective Date --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-26 Contract Amount --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-27 Contract Period --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-28 Interest Code --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-29 Transfer to Bad Debt Code --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-30 Transfer to Bad Debt Date --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-31 Bad Debt Agency Code --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-31 Bad Debt Transfer Amount --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-33 Bad Debt Recovery Amount --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-34 Delete Account Indicator --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-35 Delete Account Date --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-36 Discharge Disposition --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-37 Discharge To Location --&gt;  &lt;xsl:if test=&quot;patient/patient.health_center&quot;&gt;   &lt;xsl:value-of select=&quot;replace(patient/patient.health_center,&apos;\^&apos;,&apos;&amp;amp;&apos;)&quot; /&gt;  &lt;/xsl:if&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-38 Diet Type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-39 Servicing Facility --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-40 Bed Status --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-41 Account Status --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-42 Pending Location --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-43 Prior Temporary Location --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-44 Admit Date/Time --&gt;  &lt;xsl:call-template name=&quot;hl7Date&quot;&gt;   &lt;xsl:with-param name=&quot;date&quot; select=&quot;encounter/encounter.encounter_datetime&quot; /&gt;  &lt;/xsl:call-template&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-45 Discharge Date/Time --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-46 Current Patient Balance --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-47 Total Charges --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-48 Total Adjustments --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-49 Total Payments --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- PV1-50 Alternate Visit ID --&gt;  &lt;xsl:text&gt;|V&lt;/xsl:text&gt;             &lt;!-- PV1-51 Visit Indicator --&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;   &lt;!-- We use encounter date as the timestamp for each observation --&gt;  &lt;xsl:variable name=&quot;encounterTimestamp&quot;&gt;   &lt;xsl:call-template name=&quot;hl7Date&quot;&gt;    &lt;xsl:with-param name=&quot;date&quot; select=&quot;encounter/encounter.encounter_datetime&quot; /&gt;   &lt;/xsl:call-template&gt;  &lt;/xsl:variable&gt;    &lt;!-- ORC Common Order Segment --&gt;  &lt;xsl:text&gt;ORC&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;  &lt;xsl:text&gt;|RE&lt;/xsl:text&gt;            &lt;!-- ORC-1 Order Control (RE = obs to follow) --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-2 Placer Order Number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-3 Filler Order Number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-4 Placer Group Number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-5 Order Status --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-6 Response Flag --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-7 Quantity/Timing --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-8 Parent --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-9 Date/Time of Transaction --&gt;  &lt;xsl:call-template name=&quot;hl7Timestamp&quot;&gt;   &lt;xsl:with-param name=&quot;date&quot; select=&quot;xs:dateTime(header/date_entered)&quot; /&gt;  &lt;/xsl:call-template&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- ORC-10 Entered By --&gt;  &lt;xsl:value-of select=&quot;header/enterer&quot; /&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;   &lt;!-- Observation(s) --&gt;  &lt;xsl:variable name=&quot;obsList&quot; select=&quot;obs/*[(@openmrs_concept and value and value/text() != &apos;&apos;) or *[@openmrs_concept and text()=&apos;true&apos;]]&quot; /&gt;  &lt;xsl:variable name=&quot;obsListCount&quot; select=&quot;count($obsList)&quot; as=&quot;xs:integer&quot; /&gt;  &lt;!-- Observation OBR --&gt;  &lt;xsl:text&gt;OBR&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-1 Set ID --&gt;  &lt;xsl:text&gt;1&lt;/xsl:text&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-2 Placer order number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-3 Filler order number --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-4 OBR concept --&gt;  &lt;xsl:value-of select=&quot;obs/@openmrs_concept&quot; /&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;   &lt;!-- observation OBXs --&gt;  &lt;xsl:for-each select=&quot;$obsList&quot;&gt;   &lt;xsl:choose&gt;    &lt;xsl:when test=&quot;value&quot;&gt;     &lt;xsl:call-template name=&quot;obsObx&quot;&gt;      &lt;xsl:with-param name=&quot;setId&quot; select=&quot;position()&quot; /&gt;      &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;@openmrs_datatype&quot; /&gt;      &lt;xsl:with-param name=&quot;units&quot; select=&quot;@openmrs_units&quot; /&gt;      &lt;xsl:with-param name=&quot;concept&quot; select=&quot;@openmrs_concept&quot; /&gt;      &lt;xsl:with-param name=&quot;date&quot; select=&quot;date/text()&quot; /&gt;      &lt;xsl:with-param name=&quot;time&quot; select=&quot;time/text()&quot; /&gt;      &lt;xsl:with-param name=&quot;value&quot; select=&quot;value&quot; /&gt;      &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;     &lt;/xsl:call-template&gt;    &lt;/xsl:when&gt;    &lt;xsl:otherwise&gt;     &lt;xsl:variable name=&quot;setId&quot; select=&quot;position()&quot; /&gt;     &lt;xsl:for-each select=&quot;*[@openmrs_concept and text() = &apos;true&apos;]&quot;&gt;      &lt;xsl:call-template name=&quot;obsObx&quot;&gt;       &lt;xsl:with-param name=&quot;setId&quot; select=&quot;$setId&quot; /&gt;       &lt;xsl:with-param name=&quot;subId&quot; select=&quot;concat($setId,position())&quot; /&gt;       &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;../@openmrs_datatype&quot; /&gt;       &lt;xsl:with-param name=&quot;units&quot; select=&quot;../@openmrs_units&quot; /&gt;       &lt;xsl:with-param name=&quot;concept&quot; select=&quot;../@openmrs_concept&quot; /&gt;       &lt;xsl:with-param name=&quot;date&quot; select=&quot;../date/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;time&quot; select=&quot;../time/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;value&quot; select=&quot;@openmrs_concept&quot; /&gt;       &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;      &lt;/xsl:call-template&gt;     &lt;/xsl:for-each&gt;    &lt;/xsl:otherwise&gt;   &lt;/xsl:choose&gt;  &lt;/xsl:for-each&gt;    &lt;!-- Grouped observation(s) --&gt;  &lt;xsl:variable name=&quot;obsGroupList&quot; select=&quot;obs/*[@openmrs_concept and not(date) and *[(@openmrs_concept and value and value/text() != &apos;&apos;) or *[@openmrs_concept and text()=&apos;true&apos;]]]&quot; /&gt;  &lt;xsl:variable name=&quot;obsGroupListCount&quot; select=&quot;count($obsGroupList)&quot; as=&quot;xs:integer&quot; /&gt;  &lt;xsl:for-each select=&quot;$obsGroupList&quot;&gt;   &lt;!-- Observation OBR --&gt;   &lt;xsl:text&gt;OBR&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-1 Set ID --&gt;   &lt;xsl:value-of select=&quot;$obsListCount + position()&quot; /&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-2 Placer order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-3 Filler order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-4 OBR concept --&gt;   &lt;xsl:value-of select=&quot;@openmrs_concept&quot; /&gt;   &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;      &lt;!-- Generate OBXs --&gt;   &lt;xsl:for-each select=&quot;*[(@openmrs_concept and value and value/text() != &apos;&apos;) or *[@openmrs_concept and text()=&apos;true&apos;]]&quot;&gt;    &lt;xsl:choose&gt;     &lt;xsl:when test=&quot;value&quot;&gt;      &lt;xsl:call-template name=&quot;obsObx&quot;&gt;       &lt;xsl:with-param name=&quot;setId&quot; select=&quot;position()&quot; /&gt;       &lt;xsl:with-param name=&quot;subId&quot; select=&quot;1&quot; /&gt;       &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;@openmrs_datatype&quot; /&gt;       &lt;xsl:with-param name=&quot;units&quot; select=&quot;@openmrs_units&quot; /&gt;       &lt;xsl:with-param name=&quot;concept&quot; select=&quot;@openmrs_concept&quot; /&gt;       &lt;xsl:with-param name=&quot;date&quot; select=&quot;date/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;time&quot; select=&quot;time/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;value&quot; select=&quot;value&quot; /&gt;       &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;      &lt;/xsl:call-template&gt;     &lt;/xsl:when&gt;     &lt;xsl:otherwise&gt;      &lt;xsl:variable name=&quot;setId&quot; select=&quot;position()&quot; /&gt;      &lt;xsl:for-each select=&quot;*[@openmrs_concept and text() = &apos;true&apos;]&quot;&gt;       &lt;xsl:call-template name=&quot;obsObx&quot;&gt;        &lt;xsl:with-param name=&quot;setId&quot; select=&quot;$setId&quot; /&gt;        &lt;xsl:with-param name=&quot;subId&quot; select=&quot;concat(&apos;1.&apos;,position())&quot; /&gt;        &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;../@openmrs_datatype&quot; /&gt;        &lt;xsl:with-param name=&quot;units&quot; select=&quot;../@openmrs_units&quot; /&gt;        &lt;xsl:with-param name=&quot;concept&quot; select=&quot;../@openmrs_concept&quot; /&gt;        &lt;xsl:with-param name=&quot;date&quot; select=&quot;../date/text()&quot; /&gt;        &lt;xsl:with-param name=&quot;time&quot; select=&quot;../time/text()&quot; /&gt;        &lt;xsl:with-param name=&quot;value&quot; select=&quot;@openmrs_concept&quot; /&gt;        &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;       &lt;/xsl:call-template&gt;      &lt;/xsl:for-each&gt;     &lt;/xsl:otherwise&gt;    &lt;/xsl:choose&gt;   &lt;/xsl:for-each&gt;  &lt;/xsl:for-each&gt;   &lt;!-- Problem list(s) --&gt;  &lt;xsl:variable name=&quot;problemList&quot; select=&quot;problem_list/*[value[text() != &apos;&apos;]]&quot; /&gt;  &lt;xsl:variable name=&quot;problemListCount&quot; select=&quot;count($problemList)&quot; as=&quot;xs:integer&quot; /&gt;  &lt;xsl:if test=&quot;$problemList&quot;&gt;   &lt;!-- Problem list OBR --&gt;   &lt;xsl:text&gt;OBR&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-1 Set ID --&gt;   &lt;xsl:value-of select=&quot;$obsListCount + $obsGroupListCount + 1&quot; /&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-2 Placer order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-3 Filler order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-4 OBR concept --&gt;   &lt;xsl:value-of select=&quot;problem_list/@openmrs_concept&quot; /&gt;   &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;    &lt;!-- Problem list OBXs --&gt;   &lt;xsl:for-each select=&quot;$problemList&quot;&gt;    &lt;xsl:call-template name=&quot;obsObx&quot;&gt;     &lt;xsl:with-param name=&quot;setId&quot; select=&quot;position()&quot; /&gt;     &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;&apos;CWE&apos;&quot; /&gt;     &lt;xsl:with-param name=&quot;concept&quot; select=&quot;@openmrs_concept&quot; /&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;date/text()&quot; /&gt;     &lt;xsl:with-param name=&quot;time&quot; select=&quot;time/text()&quot; /&gt;     &lt;xsl:with-param name=&quot;value&quot; select=&quot;value&quot; /&gt;     &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;    &lt;/xsl:call-template&gt;     &lt;/xsl:for-each&gt;  &lt;/xsl:if&gt;    &lt;!-- Orders --&gt;  &lt;xsl:variable name=&quot;orderList&quot; select=&quot;orders/*[*[@openmrs_concept and ((value and value/text() != &apos;&apos;) or *[@openmrs_concept and text() = &apos;true&apos;])]]&quot; /&gt;  &lt;xsl:variable name=&quot;orderListCount&quot; select=&quot;count($orderList)&quot; as=&quot;xs:integer&quot; /&gt;  &lt;xsl:for-each select=&quot;$orderList&quot;&gt;   &lt;!-- Order section OBR --&gt;   &lt;xsl:text&gt;OBR&lt;/xsl:text&gt;            &lt;!-- Message type --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-1 Set ID --&gt;   &lt;xsl:value-of select=&quot;$obsListCount + $obsGroupListCount + $problemListCount + 1&quot; /&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-2 Placer order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-3 Filler order number --&gt;   &lt;xsl:text&gt;|&lt;/xsl:text&gt;              &lt;!-- OBR-4 OBR concept --&gt;   &lt;xsl:value-of select=&quot;@openmrs_concept&quot; /&gt;   &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt;       &lt;!-- new line --&gt;     &lt;!-- Order OBXs --&gt;   &lt;xsl:for-each select=&quot;*[@openmrs_concept and ((value and value/text() != &apos;&apos;) or *[@openmrs_concept and text() = &apos;true&apos;])]&quot;&gt;    &lt;xsl:choose&gt;     &lt;xsl:when test=&quot;value&quot;&gt;      &lt;xsl:call-template name=&quot;obsObx&quot;&gt;       &lt;xsl:with-param name=&quot;setId&quot; select=&quot;position()&quot; /&gt;       &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;@openmrs_datatype&quot; /&gt;       &lt;xsl:with-param name=&quot;units&quot; select=&quot;@openmrs_units&quot; /&gt;       &lt;xsl:with-param name=&quot;concept&quot; select=&quot;@openmrs_concept&quot; /&gt;       &lt;xsl:with-param name=&quot;date&quot; select=&quot;date/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;time&quot; select=&quot;time/text()&quot; /&gt;       &lt;xsl:with-param name=&quot;value&quot; select=&quot;value&quot; /&gt;       &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;      &lt;/xsl:call-template&gt;     &lt;/xsl:when&gt;     &lt;xsl:otherwise&gt;      &lt;xsl:variable name=&quot;setId&quot; select=&quot;position()&quot; /&gt;      &lt;xsl:for-each select=&quot;*[@openmrs_concept and text() = &apos;true&apos;]&quot;&gt;       &lt;xsl:call-template name=&quot;obsObx&quot;&gt;        &lt;xsl:with-param name=&quot;setId&quot; select=&quot;$setId&quot; /&gt;        &lt;xsl:with-param name=&quot;subId&quot; select=&quot;position()&quot; /&gt;        &lt;xsl:with-param name=&quot;datatype&quot; select=&quot;../@openmrs_datatype&quot; /&gt;        &lt;xsl:with-param name=&quot;units&quot; select=&quot;../@openmrs_units&quot; /&gt;        &lt;xsl:with-param name=&quot;concept&quot; select=&quot;../@openmrs_concept&quot; /&gt;        &lt;xsl:with-param name=&quot;date&quot; select=&quot;../date/text()&quot; /&gt;        &lt;xsl:with-param name=&quot;time&quot; select=&quot;../time/text()&quot; /&gt;        &lt;xsl:with-param name=&quot;value&quot; select=&quot;@openmrs_concept&quot; /&gt;        &lt;xsl:with-param name=&quot;encounterTimestamp&quot; select=&quot;$encounterTimestamp&quot; /&gt;       &lt;/xsl:call-template&gt;      &lt;/xsl:for-each&gt;     &lt;/xsl:otherwise&gt;    &lt;/xsl:choose&gt;   &lt;/xsl:for-each&gt;   &lt;/xsl:for-each&gt;   &lt;/xsl:template&gt;  &lt;!-- Patient Identifier (CX) generator --&gt; &lt;xsl:template name=&quot;patient_id&quot;&gt;  &lt;xsl:param name=&quot;pid&quot; /&gt;  &lt;xsl:param name=&quot;auth&quot; /&gt;  &lt;xsl:param name=&quot;type&quot; /&gt;  &lt;xsl:value-of select=&quot;$pid&quot; /&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Check digit --&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Check Digit Scheme --&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Assigning Authority --&gt;  &lt;xsl:value-of select=&quot;$auth&quot; /&gt;  &lt;xsl:text&gt;^&lt;/xsl:text&gt;              &lt;!-- Identifier Type --&gt;  &lt;xsl:value-of select=&quot;$type&quot; /&gt; &lt;/xsl:template&gt;  &lt;!-- OBX Generator --&gt; &lt;xsl:template name=&quot;obsObx&quot;&gt;  &lt;xsl:param name=&quot;setId&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;subId&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;datatype&quot; required=&quot;yes&quot; /&gt;  &lt;xsl:param name=&quot;concept&quot; required=&quot;yes&quot; /&gt;  &lt;xsl:param name=&quot;date&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;time&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;value&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;units&quot; required=&quot;no&quot;&gt;&lt;/xsl:param&gt;  &lt;xsl:param name=&quot;encounterTimestamp&quot; required=&quot;yes&quot; /&gt;  &lt;xsl:text&gt;OBX&lt;/xsl:text&gt;                     &lt;!-- Message type --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Set ID --&gt;  &lt;xsl:value-of select=&quot;$setId&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Observation datatype --&gt;  &lt;xsl:choose&gt;   &lt;xsl:when test=&quot;$datatype = &apos;BIT&apos;&quot;&gt;    &lt;xsl:text&gt;NM&lt;/xsl:text&gt;   &lt;/xsl:when&gt;   &lt;xsl:otherwise&gt;    &lt;xsl:value-of select=&quot;$datatype&quot; /&gt;   &lt;/xsl:otherwise&gt;  &lt;/xsl:choose&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Concept (what was observed --&gt;  &lt;xsl:value-of select=&quot;$concept&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Sub-ID --&gt;  &lt;xsl:value-of select=&quot;$subId&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Value --&gt;  &lt;xsl:choose&gt;   &lt;xsl:when test=&quot;$datatype = &apos;TS&apos;&quot;&gt;    &lt;xsl:call-template name=&quot;hl7Timestamp&quot;&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;$value&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:when&gt;   &lt;xsl:when test=&quot;$datatype = &apos;DT&apos;&quot;&gt;    &lt;xsl:call-template name=&quot;hl7Date&quot;&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;$value&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:when&gt;   &lt;xsl:when test=&quot;$datatype = &apos;TM&apos;&quot;&gt;    &lt;xsl:call-template name=&quot;hl7Time&quot;&gt;     &lt;xsl:with-param name=&quot;time&quot; select=&quot;$value&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:when&gt;   &lt;xsl:when test=&quot;$datatype = &apos;BIT&apos;&quot;&gt;    &lt;xsl:choose&gt;     &lt;xsl:when test=&quot;$value = &apos;0&apos; or upper-case($value) = &apos;FALSE&apos;&quot;&gt;0&lt;/xsl:when&gt;     &lt;xsl:otherwise&gt;1&lt;/xsl:otherwise&gt;    &lt;/xsl:choose&gt;   &lt;/xsl:when&gt;   &lt;xsl:otherwise&gt;    &lt;xsl:value-of select=&quot;$value&quot; /&gt;   &lt;/xsl:otherwise&gt;  &lt;/xsl:choose&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Units --&gt;  &lt;xsl:value-of select=&quot;$units&quot; /&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Reference range --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Abnormal flags --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Probability --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Nature of abnormal test --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Observation result status --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Effective date --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- User defined access checks --&gt;  &lt;xsl:text&gt;|&lt;/xsl:text&gt;                       &lt;!-- Date time of observation --&gt;  &lt;xsl:choose&gt;   &lt;xsl:when test=&quot;$date and $time&quot;&gt;    &lt;xsl:call-template name=&quot;hl7Timestamp&quot;&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;dateTime($date,$time)&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:when&gt;   &lt;xsl:when test=&quot;$date&quot;&gt;    &lt;xsl:call-template name=&quot;hl7Date&quot;&gt;     &lt;xsl:with-param name=&quot;date&quot; select=&quot;$date&quot; /&gt;    &lt;/xsl:call-template&gt;   &lt;/xsl:when&gt;   &lt;xsl:otherwise&gt;    &lt;xsl:value-of select=&quot;$encounterTimestamp&quot; /&gt;   &lt;/xsl:otherwise&gt;  &lt;/xsl:choose&gt;  &lt;xsl:text&gt;&amp;#x000d;&lt;/xsl:text&gt; &lt;/xsl:template&gt;  &lt;!-- Generate HL7-formatted timestamp --&gt; &lt;xsl:template name=&quot;hl7Timestamp&quot;&gt;  &lt;xsl:param name=&quot;date&quot; /&gt;  &lt;xsl:if test=&quot;string($date) != &apos;&apos;&quot;&gt;   &lt;xsl:value-of select=&quot;concat(year-from-dateTime($date),format-number(month-from-dateTime($date),&apos;00&apos;),format-number(day-from-dateTime($date),&apos;00&apos;),format-number(hours-from-dateTime($date),&apos;00&apos;),format-number(minutes-from-dateTime($date),&apos;00&apos;),format-number(floor(seconds-from-dateTime($date)),&apos;00&apos;))&quot; /&gt;  &lt;/xsl:if&gt; &lt;/xsl:template&gt;  &lt;!-- Generate HL7-formatted date --&gt; &lt;xsl:template name=&quot;hl7Date&quot;&gt;  &lt;xsl:param name=&quot;date&quot; /&gt;  &lt;xsl:if test=&quot;string($date) != &apos;&apos;&quot;&gt;   &lt;xsl:choose&gt;    &lt;xsl:when test=&quot;contains(string($date),&apos;T&apos;)&quot;&gt;     &lt;xsl:call-template name=&quot;hl7Date&quot;&gt;      &lt;xsl:with-param name=&quot;date&quot; select=&quot;xs:date(substring-before($date,&apos;T&apos;))&quot; /&gt;     &lt;/xsl:call-template&gt;    &lt;/xsl:when&gt;    &lt;xsl:otherwise&gt;      &lt;xsl:value-of select=&quot;concat(year-from-date($date),format-number(month-from-date($date),&apos;00&apos;),format-number(day-from-date($date),&apos;00&apos;))&quot; /&gt;    &lt;/xsl:otherwise&gt;   &lt;/xsl:choose&gt;      &lt;/xsl:if&gt; &lt;/xsl:template&gt;  &lt;!-- Generate HL7-formatted time --&gt; &lt;xsl:template name=&quot;hl7Time&quot;&gt;  &lt;xsl:param name=&quot;time&quot; /&gt;  &lt;xsl:if test=&quot;$time != &apos;&apos;&quot;&gt;   &lt;xsl:value-of select=&quot;concat(format-number(hours-from-time($time),&apos;00&apos;),format-number(minutes-from-time($time),&apos;00&apos;),format-number(floor(seconds-from-time($time)),&apos;00&apos;))&quot; /&gt;  &lt;/xsl:if&gt; &lt;/xsl:template&gt;  &lt;/xsl:stylesheet&gt;" creator="2" date_created="2005-08-07 00:00:00.0" changed_by="54709" date_changed="2007-10-24 14:51:53.0" retired="false"/>
  <form_field form_field_id="2" form_id="1" field_id="2" field_number="1" field_part="" required="false" changed_by="1" date_changed="2006-07-18 11:11:53.0" creator="1" date_created="2006-07-18 11:04:36.0" sort_weight="10.0"/>
  <form_field form_field_id="3" form_id="1" field_id="3" field_number="2" field_part="" required="false" changed_by="1" date_changed="2006-07-18 11:12:05.0" creator="1" date_created="2006-07-18 11:06:52.0" sort_weight="20.0"/>
  <form_field form_field_id="5" form_id="1" field_id="5" field_number="3" field_part="" required="false" changed_by="1" date_changed="2006-07-18 11:13:59.0" creator="1" date_created="2006-07-18 11:13:57.0" sort_weight="30.0"/>
  <global_property property="database_version" property_value="1.4.0.16"/>
</dataset>
